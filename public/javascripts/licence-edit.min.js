"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),(()=>{const e=exports.glm,t=document.querySelector("main").dataset.urlPrefix,n=exports.licenceAlias,a=exports.licenceAliasPlural,c=exports.licenseeAlias,s=exports.includeReplacementFee,i=document.querySelector("#licenceEdit--licenceId").value,o=""===i,l=(t,n,a)=>{const c=t.value,s=n.value;""!==c?e.getBankName(c,s,e=>{a.value=e&&""!==e?e:"Institution Not Found ("+c+")"}):a.value=""};let r=!1,d=!1;const u=()=>{r=!0,cityssm.enableNavBlocker()},m=document.querySelector("#form--licenceEdit");m.addEventListener("submit",e=>{e.preventDefault();const a=t+"/licences/"+(o?"doCreateLicence":"doUpdateLicence");cityssm.postJSON(a,e.currentTarget,e=>{e.success?(r=!1,cityssm.disableNavBlocker(),o||d?window.location.href=t+"/licences/"+e.licenceId.toString()+"/edit?t="+Date.now():bulmaJS.alert({message:n+" Updated Successfully",contextualColorName:"success"})):bulmaJS.alert({title:"Error Updating "+n,message:e.errorMessage,contextualColorName:"danger"})})});const p=m.querySelectorAll("input, select");for(const e of p)e.hasAttribute("name")&&e.addEventListener("change",u);const y=e=>{e.preventDefault();const t=e.currentTarget.closest(".field").querySelector("input");t.readOnly=!1,t.focus()},v=m.querySelectorAll(".is-unlock-button");for(const e of v)e.addEventListener("click",y);if(o&&document.querySelector("#is-cancel-related-licence-id-button")&&document.querySelector("#is-cancel-related-licence-id-button").addEventListener("click",e=>{e.preventDefault(),e.currentTarget.closest(".message").remove()}),!o&&document.querySelector("#panel--relatedLicences")){const s=cityssm.dateToString(new Date),o=e=>{return'<div class="columns mb-0"><div class="column"><a class="has-text-weight-bold" href="'+(t+"/licences/"+e.licenceId+(e.endDateString>=s?"/edit":""))+'" target="_blank">'+n+" #"+cityssm.escapeHTML(e.licenceNumber)+'</a></div><div class="column is-narrow is-button-container"></div></div><div class="columns is-size-7"><div class="column"><span data-tooltip="'+n+' Category">'+cityssm.escapeHTML(e.licenceCategory)+'</span></div><div class="column"><span data-tooltip="'+c+' Name">'+cityssm.escapeHTML(e.licenseeName)+'</span></div><div class="column"><span data-tooltip="Start Date">'+e.startDateString+'</span> to <span data-tooltip="End Date">'+e.endDateString+'</span></div><div class="column is-narrow">'+(e.issueDate?'<span class="tag is-success">Issued</span>':'<span class="tag is-warning">Pending</span>')+"</div></div>"},l=e=>{e.preventDefault();const a=e.currentTarget.closest(".panel-block").dataset.relatedLicenceId;bulmaJS.confirm({title:"Remove Related "+n,message:"Are you sure you want to remove this related "+n.toLowerCase()+"?<br />Note that only the relationship will be removed, not the "+n.toLowerCase()+" itself.",messageIsHtml:!0,okButton:{text:"Yes, Remove the Relationship",callbackFunction:()=>{cityssm.postJSON(t+"/licences/doDeleteRelatedLicence",{licenceId:i,relatedLicenceId:a},e=>{e.success&&r(e.relatedLicences)})}}})},r=e=>{const t=document.querySelector("#panel--relatedLicences"),n=t.querySelectorAll(".panel-block");for(const e of n)e.remove();if(0===e.length){const e=document.createElement("div");e.className="panel-block is-block",e.innerHTML='<div class="message is-small is-info"><p class="message-body">There are no related '+a.toLowerCase()+".</p></div>",t.append(e)}for(const n of e){const e=document.createElement("div");e.className="panel-block is-block",e.dataset.relatedLicenceId=n.licenceId.toString(),e.innerHTML=o(n);const a=document.createElement("button");a.className="button is-small is-inverted is-danger",a.type="button",a.ariaLabel="Delete Related Licence",a.innerHTML='<i class="fas fa-trash" aria-hidden="true"></i>',a.addEventListener("click",l),e.querySelector(".is-button-container").append(a),t.append(e)}};document.querySelector("#button--addRelatedLicence").addEventListener("click",n=>{n.preventDefault();const c=n.currentTarget;let s;const l=e=>{e.preventDefault();const n=e.currentTarget.closest(".panel-block"),a=n.dataset.licenceId;cityssm.postJSON(t+"/licences/doAddRelatedLicence",{licenceId:i,relatedLicenceId:a},e=>{e.success&&(n.remove(),r(e.relatedLicences))})},d=e=>{e&&e.preventDefault();const n=s.querySelector("#container--relatableLicences");n.innerHTML='<div class="my-4 has-text-centered has-text-grey-light"><i class="fas fa-4x fa-spinner fa-pulse"></i><br /><em>Loading '+a.toLowerCase()+"...</em></div>";const c=s.querySelector("#addRelatedLicence--searchString").value;cityssm.postJSON(t+"/licences/doGetRelatableLicences",{licenceId:i,searchString:c},e=>{if(0===e.licences.length)return void(n.innerHTML='<div class="message is-info"><p class="message-body">There are no '+a.toLowerCase()+" that meet your criteria.</p></div>");const t=document.createElement("div");t.className="panel";for(const n of e.licences){const e=document.createElement("div");e.className="panel-block is-block",e.dataset.licenceId=n.licenceId.toString(),e.innerHTML=o(n);const a=document.createElement("button");a.className="button is-small is-success",a.type="button",a.ariaLabel="Add Related Licence",a.innerHTML='<i class="fas fa-plus" aria-hidden="true"></i>',a.addEventListener("click",l),e.querySelector(".is-button-container").append(a),t.append(e)}n.innerHTML="",n.append(t)})};cityssm.openHtmlModal("relatedLicence-add",{onshow:t=>{s=t,e.populateAliases(t),document.querySelector("#addRelatedLicence--searchString").addEventListener("change",d),d()},onshown:()=>{bulmaJS.toggleHtmlClipped(),document.querySelector("#addRelatedLicence--searchString").focus()},onremoved:()=>{bulmaJS.toggleHtmlClipped(),c.focus()}})}),r(exports.relatedLicences)}const g=document.querySelector("#licenceEdit--bankInstitutionNumber"),h=document.querySelector("#licenceEdit--bankTransitNumber");if(exports.includeBatches){const e=e=>{e.preventDefault();const t=document.querySelector("#licenceEdit--bankName");l(g,h,t)};g.addEventListener("change",e),h.addEventListener("change",e)}const b=document.querySelector("#licenceEdit--licenceCategoryKey"),S=document.querySelector("#licenceEdit--isRenewal"),f=document.querySelector("#licenceEdit--startDateString"),L=document.querySelector("#licenceEdit--endDateString"),q=()=>{const e=f.valueAsDate;if(L.readOnly=!0,!e||""===b.value)return void(L.value="");const n=b.selectedOptions[0],a=n.dataset.licenceLengthFunction;if(""===a){const t=Number.parseInt(n.dataset.licenceLengthYears),a=Number.parseInt(n.dataset.licenceLengthMonths),c=Number.parseInt(n.dataset.licenceLengthDays);t>0&&(e.setFullYear(e.getFullYear()+t),e.setDate(e.getDate()-1)),a>0&&(e.setMonth(e.getMonth()+a),e.setDate(e.getDate()-1)),c>0&&e.setDate(e.getDate()+c-1),L.valueAsDate=e}else cityssm.postJSON(t+"/licences/doGetLicenceEndDate",{licenceLengthFunction:a,startDateString:f.value},e=>{e.success?L.value=e.endDateString:bulmaJS.alert({title:"End Date Error",message:e.errorMessage,contextualColorName:"danger"})})};let A;o&&(b.addEventListener("change",q),""!==b.value&&q()),f.addEventListener("change",q);const F=()=>{const e=document.querySelector("#licenceEdit--baseLicenceFee"),t=document.querySelector("#licenceEdit--baseReplacementFee");if(!A||0===A.licenceCategoryFees.length)return e.value="",void(t&&(t.value=""));e.value=S.checked?A.licenceCategoryFees[0].renewalFee.toFixed(2):A.licenceCategoryFees[0].licenceFee.toFixed(2),t&&(t.value=A.licenceCategoryFees[0].replacementFee.toFixed(2)),o||k.classList.contains("is-hidden")||(k.classList.add("is-hidden"),k.insertAdjacentHTML("beforebegin",'<div class="message is-warning"><p class="message-body">Fees will be recalculated after saving.</p></div>'),k.closest(".panel").querySelector(".panel-heading .level-right").classList.add("is-hidden"),d=!0)},w=()=>{(()=>{const e=document.querySelector("#container--licenceFields");if(!A||0===A.licenceCategoryFields.length)return e.innerHTML="",void e.classList.add("is-hidden");e.classList.remove("is-hidden"),e.innerHTML='<h2 class="panel-heading">Fields</h2>';const t=[];for(const n of A.licenceCategoryFields){const a=document.createElement("div");a.className="panel-block is-block",a.innerHTML='<div class="field"><label class="label"></label><div class="control"><input class="input" type="text" /></div></div>';const c="licenceFieldEdit--"+n.licenceFieldKey,s=a.querySelector("label");s.setAttribute("for",c),s.textContent=n.licenceField;const i=a.querySelector("input");if(i.id=c,i.name="field--"+n.licenceFieldKey,i.minLength=n.minimumLength,i.maxLength=n.maximumLength,""!==n.pattern&&(i.pattern=n.pattern),n.isRequired&&(i.required=!0),""!==n.licenceFieldDescription){const e=document.createElement("p");e.className="help",e.textContent=n.licenceFieldDescription,a.append(e)}e.append(a),t.push(n.licenceFieldKey)}const n=document.createElement("input");n.type="hidden",n.name="licenceFieldKeys",n.value=t.join(","),e.append(n)})(),(()=>{const e=document.querySelector("#container--licenceApprovals");if(!A||0===A.licenceCategoryApprovals.length)return e.innerHTML="",void e.classList.add("is-hidden");e.classList.remove("is-hidden"),e.innerHTML='<h2 class="panel-heading">Approvals</h2>';const t=[];for(const n of A.licenceCategoryApprovals){const a=document.createElement("div");a.className="panel-block is-block",a.innerHTML='<div class="facheck"><input type="checkbox" /><label></label></div>';const c="licenceApprovalEdit--"+n.licenceApprovalKey,s=a.querySelector("label");s.setAttribute("for",c),s.textContent=n.licenceApproval;const i=a.querySelector("input");if(i.id=c,i.name="approval--"+n.licenceApprovalKey,i.dataset.isRequiredForNew=n.isRequiredForNew?"true":"false",i.dataset.isRequiredForRenewal=n.isRequiredForRenewal?"true":"false",(S.checked&&n.isRequiredForRenewal||!S.checked&&n.isRequiredForNew)&&(i.required=!0),""!==n.licenceApprovalDescription){const e=document.createElement("p");e.className="help",e.textContent=n.licenceApprovalDescription,a.append(e)}e.append(a),t.push(n.licenceApprovalKey)}const n=document.createElement("input");n.type="hidden",n.name="licenceApprovalKeys",n.value=t.join(","),e.append(n)})(),F()},E=()=>{if(""===b.value)return A=void 0,void w();cityssm.postJSON(t+"/licences/doGetLicenceCategory",{licenceCategoryKey:b.value},e=>{A=e.licenceCategory,w()})};let N;o?(b.addEventListener("change",E),""!==b.value&&E()):A=exports.licenceCategory,S.addEventListener("change",()=>{const e=document.querySelector("#container--licenceApprovals").querySelectorAll("input");for(const t of e)t.required=!!(S.checked&&"true"===t.dataset.isRequiredForRenewal||!S.checked&&"true"===t.dataset.isRequiredForNew);F()});const k=document.querySelector("#table--licenceAdditionalFees"),D=e=>{e.preventDefault();const n=e.currentTarget.closest("tr"),a=n.dataset.licenceAdditionalFeeKey;bulmaJS.confirm({title:"Delete Additional Fee",message:"Are you sure you want to remove this additional fee?",contextualColorName:"warning",okButton:{text:"Yes, Remove the Fee",callbackFunction:()=>{cityssm.postJSON(t+"/licences/doDeleteAdditionalFee",{licenceId:i,licenceAdditionalFeeKey:a},e=>{e.success&&(n.remove(),document.querySelector("#licenceEdit--licenceFee").value=e.licenceFee.toFixed(2),H())})}}})},x=e=>{let n;e.preventDefault();const a=e=>{e.preventDefault(),cityssm.postJSON(t+"/licences/doAddAdditionalFee",e.currentTarget,e=>{if(!e.success)return void bulmaJS.alert({title:"Error Adding Additional Fee",message:"Please try again.",contextualColorName:"danger"});const t=document.createElement("tr");t.dataset.licenceAdditionalFeeKey=e.additionalFee.licenceAdditionalFeeKey,t.innerHTML='<td class="has-width-1"><i class="fas fa-plus" aria-label="Plus"></i></td><td>'+cityssm.escapeHTML(e.additionalFee.additionalFee)+'</td><td class="has-text-right">$'+e.additionalFee.additionalFeeAmount.toFixed(2)+'</td><td class="has-width-1"><button class="button is-small is-danger is-inverted" type="button" aria-label="Delete Additional Fee"><i class="fas fa-trash" aria-hidden="true"></i></td>',t.querySelector("button").addEventListener("click",D),k.querySelector("tbody").append(t),document.querySelector("#licenceEdit--licenceFee").value=e.licenceFee.toFixed(2),n(),H()})};cityssm.openHtmlModal("additionalFee-add",{onshown:(e,t)=>{n=t,bulmaJS.toggleHtmlClipped(),e.querySelector("#additionalFeeAdd--licenceId").value=i;const c=N.filter(e=>!k.querySelector("tbody tr[data-licence-additional-fee-key='"+e.licenceAdditionalFeeKey+"']"));if(0===c.length)return t(),void bulmaJS.alert({title:"No Additional Fees Available",message:"All available additional fees are already included.",contextualColorName:"info"});const s=e.querySelector("#additionalFeeAdd--licenceAdditionalFeeKey");for(const e of c){const t=document.createElement("option");t.value=e.licenceAdditionalFeeKey,t.textContent=e.additionalFee,s.append(t)}e.querySelector("#form--additionalFeeAdd").addEventListener("submit",a)}})};if(!o){const e=document.querySelector("#button--addAdditionalFee");e&&(N=A.licenceCategoryAdditionalFees.filter(e=>!e.isRequired),e.addEventListener("click",x));const t=k.querySelectorAll(".is-delete-additional-fee-button");for(const e of t)e.addEventListener("click",D)}const T=document.querySelector("#table--licenceTransactions");let C=exports.licenceTransactions;const I=()=>{const e=document.querySelector("#licenceEdit--licenceFee").value,t=T.querySelector("#transactions--total").textContent.slice(1);return Math.max(Number.parseFloat(e)-Number.parseFloat(t),0)},R=e=>{e.preventDefault();const n=e.currentTarget.closest("tr").dataset.transactionIndex;bulmaJS.confirm({title:"Delete Transaction",message:"Are you sure you want to delete this transaction? In the event of a refund, it may be better to create a new negative transaction.",contextualColorName:"danger",okButton:{text:"Yes, Delete the Transaction",callbackFunction:()=>{cityssm.postJSON(t+"/licences/doDeleteLicenceTransaction",{licenceId:i,transactionIndex:n},e=>{e.success&&(C=e.licenceTransactions,H())})}}})},H=()=>{const e=T.querySelector("tbody");e.innerHTML="";let t=0;const n=cityssm.dateToString(new Date);for(const a of C){const c=document.createElement("tr");c.dataset.transactionIndex=a.transactionIndex.toString(),c.innerHTML="<td><p>"+a.transactionDateString+"<p>"+(a.transactionNote&&""!==a.transactionNote?'<p class="is-size-7">'+cityssm.escapeHTML(a.transactionNote)+"</p>":"")+'<div class="tags">'+(n<a.transactionDateString?'<span class="tag is-warning">Upcoming</span>':"")+(a.batchDate?'<span class="tag is-info">Batch Transaction</span>':"")+(!a.batchDate||a.externalReceiptNumber&&""!==a.externalReceiptNumber?"":'<span class="tag is-warning">Unconfirmed</span>')+'</div></td><td class="has-text-right'+(0===a.transactionAmount?" has-text-danger":"")+'">$'+a.transactionAmount.toFixed(2)+'</td><td><button class="button is-small is-danger is-inverted" type="button" aria-label="Delete Transaction"><i class="fas fa-trash" aria-hidden="true"></i></button></td>',c.querySelector("button").addEventListener("click",R),e.append(c),t+=a.transactionAmount}const a=T.querySelector("tfoot");a.innerHTML='<tr><th>Total</th><th id="transactions--total" class="has-text-right">$'+t.toFixed(2)+"</th><th></th></tr>";const c=I();c>0&&a.insertAdjacentHTML("beforeend",'<tr class="has-background-danger-light"><th>Outstanding Balance</th><th class="has-text-right">$'+c.toFixed(2)+"</th><th></th></tr>")},M=e=>{e.preventDefault();const t=e.currentTarget.closest(".modal"),n=t.querySelector("#transactionAdd--bankInstitutionNumber"),a=t.querySelector("#transactionAdd--bankTransitNumber"),c=t.querySelector("#transactionAdd--bankName");l(n,a,c)},J=n=>{let a,c;n.preventDefault();const o=e=>{e.preventDefault(),cityssm.postJSON(t+"/licences/doAddLicenceTransaction",e.currentTarget,e=>{e.success&&(C=e.licenceTransactions,H(),c())})},l=e=>{e.preventDefault();const t=e.currentTarget.dataset.spanId;a.querySelector("#transactionAdd--transactionAmount").value=a.querySelector("#"+t).textContent};cityssm.openHtmlModal("transaction-add",{onshow:t=>{e.populateAliases(t),t.querySelector("#transactionAdd--licenceId").value=i;const n=document.querySelector("#licenceEdit--licenceFee").value;t.querySelector("#transactionAdd--licenceFee").textContent=n,s?t.querySelector("#transactionAdd--replacementFee").textContent=document.querySelector("#licenceEdit--replacementFee").value:t.querySelector("#transactionAdd--replacementFee").closest("tr").remove();const a=I();t.querySelector("#transactionAdd--outstandingBalance").textContent=a.toFixed(2),t.querySelector("#transactionAdd--transactionAmount").value=a>0||!s?a.toFixed(2):document.querySelector("#licenceEdit--replacementFee").value},onshown:(e,t)=>{a=e,c=t,e.querySelector("#transactionAdd--transactionAmount").focus();const n=e.querySelectorAll(".is-set-transaction-amount-button");for(const e of n)e.addEventListener("click",l);const s=e.querySelector("#transactionAdd--bankInstitutionNumber"),i=e.querySelector("#transactionAdd--bankTransitNumber");e.querySelector("button.is-more-fields-button").addEventListener("click",t=>{t.preventDefault(),t.currentTarget.remove();let n=".is-more-fields";exports.includeBatches&&(n+=", .is-more-fields-batch");for(const t of e.querySelectorAll(n))t.classList.remove("is-hidden");exports.includeBatches&&(s.addEventListener("change",M),i.addEventListener("change",M))}),exports.includeBatches&&e.querySelector("button.is-copy-bank-numbers-button").addEventListener("click",t=>{t.preventDefault(),s.value=g.value,i.value=h.value,e.querySelector("#transactionAdd--bankName").value=document.querySelector("#licenceEdit--bankName").value,e.querySelector("#transactionAdd--bankAccountNumber").value=document.querySelector("#licenceEdit--bankAccountNumber").value}),e.querySelector("#form--transactionAdd").addEventListener("submit",o)}})};if(!o){H(),document.querySelector("#button--addTransaction").addEventListener("click",J);const e=document.querySelectorAll(".is-delete-transaction-button");for(const t of e)t.addEventListener("click",R)}const P=document.querySelector("#is-issue-licence-button");if(P){const e=()=>{cityssm.postJSON(t+"/licences/doIssueLicence",{licenceId:i},e=>{e.success&&(window.location.href=t+"/licences/"+i+"/edit?t="+Date.now())})};P.addEventListener("click",t=>{t.preventDefault(),r?bulmaJS.alert({title:n+" Has Unsaved Changes",message:"Please save your "+n.toLowerCase()+" changes before issuing the "+n.toLowerCase()+".",contextualColorName:"warning"}):I()>0?bulmaJS.confirm({title:n+" Has an Outstanding Balance",message:"Are you sure you want to issue this "+n.toLowerCase()+" with an outstanding balance?",contextualColorName:"warning",okButton:{text:"Yes, Issue with Outstanding Balance",callbackFunction:e}}):f.value<cityssm.dateToString(new Date)?bulmaJS.confirm({title:n+" Has a Start Date in the Past",message:"Are you sure you want to issue this "+n.toLowerCase()+" with a start date in the past?",contextualColorName:"warning",okButton:{text:"Yes, Issue with a Past Start Date",callbackFunction:e}}):bulmaJS.confirm({title:"Issue "+n,message:"Are you sure you want to issue this "+n.toLowerCase()+"?",contextualColorName:"info",okButton:{text:"Yes, Issue "+n,callbackFunction:e}})})}if(!o&&!P){const e=()=>{const e=new URL(window.location.protocol+"//"+window.location.host+t+"/licences/new");e.searchParams.append("licenceCategoryKey",b.value),e.searchParams.append("isRenewal","true"),e.searchParams.append("licenseeName",document.querySelector("#licenceEdit--licenseeName").value),e.searchParams.append("licenseeBusinessName",document.querySelector("#licenceEdit--licenseeBusinessName").value),e.searchParams.append("licenseeAddress1",document.querySelector("#licenceEdit--licenseeAddress1").value),e.searchParams.append("licenseeAddress2",document.querySelector("#licenceEdit--licenseeAddress2").value),e.searchParams.append("licenseeCity",document.querySelector("#licenceEdit--licenseeCity").value),e.searchParams.append("licenseeProvince",document.querySelector("#licenceEdit--licenseeProvince").value),e.searchParams.append("licenseePostalCode",document.querySelector("#licenceEdit--licenseePostalCode").value),g&&(e.searchParams.append("bankInstitutionNumber",g.value),e.searchParams.append("bankTransitNumber",h.value),e.searchParams.append("bankAccountNumber",document.querySelector("#licenceEdit--bankAccountNumber").value));let n=L.valueAsDate;n.setDate(n.getDate()+1),n.getTime()<Date.now()&&(n=new Date),e.searchParams.append("startDateString",cityssm.dateToString(n)),window.location.href=e.toString()};document.querySelector("#is-renew-licence-button").addEventListener("click",t=>{t.preventDefault(),bulmaJS.confirm({title:"Renew "+n,message:"Are you sure you want to renew this "+n.toLowerCase()+"?",okButton:{text:"Yes, Renew this "+n,callbackFunction:e}})})}o||document.querySelector("#is-delete-licence-button").addEventListener("click",e=>{e.preventDefault();const a=!P,c=L.value<cityssm.dateToString(new Date);bulmaJS.confirm({title:"Delete "+n,message:"<p>Are you sure you want to delete this "+n.toLowerCase()+"?</p>"+(a?"<p>Note that <strong>this "+n.toLowerCase()+" has been issued</strong>, and deleting it may cause confusion.</p>":""),messageIsHtml:!0,contextualColorName:c?"info":"warning",okButton:{text:"Yes, Delete "+n,callbackFunction:()=>{cityssm.postJSON(t+"/licences/doDeleteLicence",{licenceId:i},e=>{e.success&&(window.location.href=t+"/licences")})}}})})})();