"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),(()=>{const t=document.querySelector("main").dataset.urlPrefix,e=exports.licenceAlias,a=document.querySelector("#table--transactionBatches");let n=[];const c=a=>{a.preventDefault();const n=a.currentTarget,c=n.value,s=n.closest("td").dataset.batchDateString,l=n.closest("tr").dataset.licenceId;cityssm.postJSON(t+"/batches/doCreateOrUpdateBatchTransaction",{licenceId:l,batchDateString:s,transactionAmount:c},t=>{if(t.success&&(o=t.batchTransactions,r()),t.message){const a=n.closest("tr").dataset.licenceNumber;bulmaJS.alert({title:e+" #"+a+", Batch "+s,message:t.message,contextualColorName:t.success?"warning":"danger"})}})},s=()=>{const t=a.querySelectorAll("[data-batch-date-string]");for(const e of t)e.remove();const e=a.querySelectorAll("tbody tr");for(const t of n){const n=document.createElement("th");n.className="has-text-centered",n.dataset.batchDateString=t,n.innerHTML=t,a.querySelector("thead th:last-child").insertAdjacentElement("beforebegin",n);const s=document.createElement("th");s.className="has-text-right",s.dataset.batchDateString=t,a.querySelector("tfoot th:last-child").insertAdjacentElement("beforebegin",s);for(const a of e){const e=document.createElement("td");e.dataset.batchDateString=t,e.innerHTML='<div class="control has-icons-left"><input class="input is-small has-text-right" data-field="transactionAmount" type="number" min="0" onwheel="return false" /><span class="icon is-small is-left"><i class="fas fa-dollar-sign" aria-hidden="true"></i></span></div>';const n=e.querySelector("input");n.min="0",n.max=a.dataset.outstandingBalance,n.step="0.01",n.addEventListener("change",c),a.querySelector("td:last-child").insertAdjacentElement("beforebegin",e)}}};let o=exports.batchTransactions;(()=>{const t=new Set;for(const e of o)t.add(e.batchDateString);(n=[...t.values()]).sort()})();const r=()=>{const t=a.querySelectorAll("input[data-field='transactionAmount']");for(const e of t)e.value="";const e=new Map,n=new Map;for(const t of o){const c=a.querySelector("tr[data-licence-id='"+t.licenceId.toString()+"']").querySelector("td[data-batch-date-string='"+t.batchDateString+"']").querySelector("input"),s=Number.parseFloat(c.value)||0;c.value=(s+t.transactionAmount).toFixed(2),c.classList.remove("has-background-danger-light"),c.checkValidity()||c.classList.add("has-background-danger-light"),e.has(t.licenceId)?e.set(t.licenceId,e.get(t.licenceId)+t.transactionAmount):e.set(t.licenceId,t.transactionAmount),n.has(t.batchDateString)?n.set(t.batchDateString,n.get(t.batchDateString)+t.transactionAmount):n.set(t.batchDateString,t.transactionAmount)}const c=a.querySelectorAll("tbody tr[data-licence-id]");for(const t of c){const a=Number.parseInt(t.dataset.licenceId,10),n=Number.parseFloat(t.dataset.outstandingBalance),c=e.has(a)?e.get(a):0,s=t.querySelector("td:last-child");s.textContent="$"+c.toFixed(2),s.classList.remove("has-background-success-light","has-background-danger-light"),n===c?s.classList.add("has-background-success-light"):n<c&&s.classList.add("has-background-danger-light")}const s=a.querySelectorAll("tfoot th[data-batch-date-string]");for(const t of s){const e=t.dataset.batchDateString;t.textContent=n.has(e)?"$"+n.get(e).toFixed(2):"$0.00"}};s(),r();const l=e=>{e.preventDefault();const a=e.currentTarget.closest("tr"),c=a.dataset.licenceId,s=a.dataset.outstandingBalance,l=()=>{cityssm.postJSON(t+"/batches/doSplitOutstandingBalance",{licenceId:c,batchDateStrings:n,outstandingBalance:s},t=>{t.success&&(o=t.batchTransactions,r())})};0===n.length?bulmaJS.alert({message:"There are no batches available."}):bulmaJS.confirm({title:"Split Balance Across Batches",message:"Are you sure you want to evenly split the outstanding balance across "+n.length+" batch"+(1===n.length?"":"es")+"?",okButton:{text:"Yes, Split the Balance",callbackFunction:l}})},i=document.querySelectorAll(".is-split-outstanding-balance-button");for(const t of i)t.addEventListener("click",l);const d=e=>{e.preventDefault();const a=e.currentTarget.closest("tr").dataset.licenceId;bulmaJS.confirm({title:"Clear All Transactions",message:"Are you sure you want to clear all transaction amounts in this row?",contextualColorName:"warning",okButton:{text:"Yes, Clear All Trasnactions",callbackFunction:()=>{cityssm.postJSON(t+"/batches/doClearLicenceBatchTransactions",{licenceId:a},t=>{t.success&&(o=t.batchTransactions,r())})}}})},u=document.querySelectorAll(".is-clear-licence-button");for(const t of u)t.addEventListener("click",d);document.querySelector("#is-add-batch-button").addEventListener("click",t=>{let e,a;t.preventDefault();const c=t=>{t.preventDefault();const c=e.value;n.includes(c)?bulmaJS.alert({title:"Batch Date Already Included",message:"To add a new batch, choose a new date."}):(n.push(c),n.sort(),a(),s(),r())};cityssm.openHtmlModal("batchBuilder-addBatch",{onshown:(t,n)=>{e=t.querySelector("#addBatch--batchDateString"),a=n,t.querySelector("#form--addBatch").addEventListener("submit",c)},onremoved:()=>{bulmaJS.toggleHtmlClipped()}})})})();