"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),(()=>{var t;const e=exports.glm,a=null===(t=document.querySelector("main"))||void 0===t?void 0:t.dataset.urlPrefix,s=exports.licenceAlias,n=document.querySelector("#table--transactionBatches");let c=[];const o=t=>{var e;t.preventDefault();const s=null===(e=t.currentTarget.closest("th"))||void 0===e?void 0:e.dataset.batchDateString;bulmaJS.confirm({title:"Clear and Remove Batch",message:"Are you sure you want to clear all amounts in this batch?",contextualColorName:"warning",okButton:{text:"Yes, Clear the Batch",callbackFunction:()=>{cityssm.postJSON(a+"/batches/doClearBatchTransactions",{batchDateString:s},t=>{t.success&&(i=t.batchTransactions,d(),r(),u())})}}})},l=t=>{t.preventDefault();const e=t.currentTarget,n=e.value,c=e.closest("td").dataset.batchDateString,o=e.closest("tr").dataset.licenceId;cityssm.postJSON(a+"/batches/doCreateOrUpdateBatchTransaction",{licenceId:o,batchDateString:c,transactionAmount:n},t=>{if(t.success&&(i=t.batchTransactions,u()),t.message){const a=e.closest("tr").dataset.licenceNumber;bulmaJS.alert({title:s+" #"+a+", Batch "+c,message:t.message,contextualColorName:t.success?"warning":"danger"})}})},r=()=>{const t=n.querySelectorAll("[data-batch-date-string]");for(const e of t)e.remove();const s=n.querySelectorAll("tbody tr");for(const t of c){const c=document.createElement("th");c.dataset.batchDateString=t,c.innerHTML='<div class="level is-mobile mb-0"><div class="level-left"><div class="level-item">'+t+'</div></div><div class="level-right"><div class="level-item"><div class="dropdown is-up is-right has-text-weight-normal"><div class="dropdown-trigger"><button class="button is-small is-white has-tooltip-left" data-tooltip="Batch Options" type="button" aria-label="Batch Options"><i class="fas fa-bars" aria-hidden="true"></i></button></div><div class="dropdown-menu"><div class="dropdown-content"><a class="dropdown-item" href="'+a+"/reports/licenceTransactions-byDate?batchDateString="+t+'"><span class="icon"><i class="fas fa-file-csv" aria-hidden="true"></i></span> <span>Transaction Report</span></a><hr class="dropdown-divider"><a class="dropdown-item is-clear-batch-button" role="button" href="#"><span class="icon"><i class="fas fa-trash" aria-hidden="true"></i></span> <span>Clear and Remove Batch</span></a></div></div></div></div></div></div><div class="has-text-centered is-size-7">'+e.getDayName(t)+"</div>",c.querySelector(".is-clear-batch-button").addEventListener("click",o),n.querySelector("thead th:last-child").insertAdjacentElement("beforebegin",c);const r=document.createElement("th");r.className="has-text-right",r.dataset.batchDateString=t,n.querySelector("tfoot th:last-child").insertAdjacentElement("beforebegin",r);for(const e of s){const a=document.createElement("td");a.dataset.batchDateString=t,a.innerHTML='<div class="control has-icons-left"><input class="input is-small has-text-right" data-field="transactionAmount" type="number" min="0" onwheel="return false" /><span class="icon is-small is-left"><i class="fas fa-dollar-sign" aria-hidden="true"></i></span></div>';const s=a.querySelector("input");s.min="0",s.max=e.dataset.outstandingBalance,s.step="0.01",s.addEventListener("change",l),e.querySelector("td:last-child").insertAdjacentElement("beforebegin",a)}}bulmaJS.init(n)};let i=exports.batchTransactions;const d=()=>{const t=new Set;for(const e of i)t.add(e.batchDateString);(c=[...t.values()]).sort()};d();const u=()=>{const t=n.querySelectorAll("input[data-field='transactionAmount']");for(const e of t)e.value="";const e=new Map,a=new Map;for(const t of i){const s=n.querySelector("tr[data-licence-id='"+t.licenceId.toString()+"']").querySelector("td[data-batch-date-string='"+t.batchDateString+"']").querySelector("input"),c=Number.parseFloat(s.value)||0;s.value=(c+t.transactionAmount).toFixed(2),s.classList.remove("has-background-danger-light"),s.checkValidity()||s.classList.add("has-background-danger-light"),e.has(t.licenceId)?e.set(t.licenceId,e.get(t.licenceId)+t.transactionAmount):e.set(t.licenceId,t.transactionAmount),a.has(t.batchDateString)?a.set(t.batchDateString,a.get(t.batchDateString)+t.transactionAmount):a.set(t.batchDateString,t.transactionAmount)}const s=n.querySelectorAll("tbody tr[data-licence-id]");for(const t of s){const a=Number.parseInt(t.dataset.licenceId,10),s=Number.parseFloat(t.dataset.outstandingBalance),n=e.has(a)?e.get(a):0,c=t.querySelector("td:last-child");c.textContent="$"+n.toFixed(2),c.classList.remove("has-background-success-light","has-background-danger-light"),s.toFixed(2)===n.toFixed(2)?c.classList.add("has-background-success-light"):s<n&&c.classList.add("has-background-danger-light")}const c=n.querySelectorAll("tfoot th[data-batch-date-string]");for(const t of c){const e=t.dataset.batchDateString;t.textContent=a.has(e)?"$"+a.get(e).toFixed(2):"$0.00"}};r(),u();const h=t=>{t.preventDefault();const e=t.currentTarget.closest("tr"),s=e.dataset.licenceId,n=e.dataset.outstandingBalance,o=()=>{cityssm.postJSON(a+"/batches/doSplitOutstandingBalances",{licenceOutstandingBalances:[{licenceId:s,outstandingBalance:n}],batchDateStrings:c},t=>{t.success&&(i=t.batchTransactions,u())})};0===c.length?bulmaJS.alert({message:"There are no batches available."}):bulmaJS.confirm({title:"Split Balance Across Batches",message:"Are you sure you want to evenly split the outstanding balance across "+c.length+" batch"+(1===c.length?"":"es")+"?",okButton:{text:"Yes, Split the Balance",callbackFunction:o}})},b=document.querySelectorAll(".is-split-outstanding-balance-button");for(const t of b)t.addEventListener("click",h);document.querySelector(".is-split-outstanding-balances-button").addEventListener("click",t=>{t.preventDefault();const e=n.querySelectorAll("tbody tr"),s=[];for(const t of e)s.push({licenceId:t.dataset.licenceId,outstandingBalance:t.dataset.outstandingBalance});const o=()=>{cityssm.postJSON(a+"/batches/doSplitOutstandingBalances",{licenceOutstandingBalances:s,batchDateStrings:c},t=>{t.success&&(i=t.batchTransactions,u())})};0===c.length?bulmaJS.alert({message:"There are no batches available."}):bulmaJS.confirm({title:"Split Balances Across Batches",message:"Are you sure you want to evenly split the outstanding balances across "+c.length+" batch"+(1===c.length?"":"es")+"?",okButton:{text:"Yes, Split the Balance",callbackFunction:o}})});const g=t=>{t.preventDefault();const e=t.currentTarget.closest("tr").dataset.licenceId;bulmaJS.confirm({title:"Clear All Transactions",message:"Are you sure you want to clear all transaction amounts in this row?",contextualColorName:"warning",okButton:{text:"Yes, Clear All Transactions",callbackFunction:()=>{cityssm.postJSON(a+"/batches/doClearLicenceBatchTransactions",{licenceIds:[e]},t=>{t.success&&(i=t.batchTransactions,u())})}}})},m=document.querySelectorAll(".is-clear-licence-button");for(const t of m)t.addEventListener("click",g);document.querySelector(".is-clear-licences-button").addEventListener("click",t=>{t.preventDefault();const e=n.querySelectorAll("tbody tr"),s=[];for(const t of e)s.push(t.dataset.licenceId);bulmaJS.confirm({title:"Clear All Transactions",message:"Are you sure you want to clear all transaction amounts?",contextualColorName:"warning",okButton:{text:"Yes, Clear All Transactions",callbackFunction:()=>{cityssm.postJSON(a+"/batches/doClearLicenceBatchTransactions",{licenceIds:s},t=>{t.success&&(i=t.batchTransactions,u())})}}})}),document.querySelector("#is-add-batch-button").addEventListener("click",t=>{let e,a;t.preventDefault();const s=t=>{t.preventDefault();const s=e.value;c.includes(s)?bulmaJS.alert({title:"Batch Date Already Included",message:"To add a new batch, choose a new date."}):(c.push(s),c.sort(),a(),r(),u())};cityssm.openHtmlModal("batchBuilder-addBatch",{onshown:(t,n)=>{e=t.querySelector("#addBatch--batchDateString"),a=n,t.querySelector("#form--addBatch").addEventListener("submit",s)},onremoved:()=>{bulmaJS.toggleHtmlClipped()}})})})();