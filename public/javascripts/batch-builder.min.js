"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),(()=>{const t=document.querySelector("main").dataset.urlPrefix,e=exports.licenceAlias,a=document.querySelector("#table--transactionBatches");let n=[];const s=a=>{a.preventDefault();const n=a.currentTarget,s=n.value,c=n.closest("td").dataset.batchDateString,l=n.closest("tr").dataset.licenceId;cityssm.postJSON(t+"/batches/doCreateOrUpdateBatchTransaction",{licenceId:l,batchDateString:c,transactionAmount:s},t=>{if(t.success&&(o=t.batchTransactions,r()),t.message){const a=n.closest("tr").dataset.licenceNumber;bulmaJS.alert({title:e+" #"+a+", Batch "+c,message:t.message,contextualColorName:t.success?"warning":"danger"})}})},c=()=>{const t=a.querySelectorAll("[data-batch-date-string]");for(const e of t)e.remove();const e=a.querySelectorAll("tbody tr");for(const t of n){const n=document.createElement("th");n.className="has-text-centered",n.dataset.batchDateString=t,n.innerHTML=t,a.querySelector("thead th:last-child").insertAdjacentElement("beforebegin",n);const c=document.createElement("th");c.className="has-text-right",c.dataset.batchDateString=t,a.querySelector("tfoot th:last-child").insertAdjacentElement("beforebegin",c);for(const a of e){const e=document.createElement("td");e.dataset.batchDateString=t,e.innerHTML='<div class="control has-icons-left"><input class="input is-small has-text-right" data-field="transactionAmount" type="number" min="0" /><span class="icon is-small is-left"><i class="fas fa-dollar-sign" aria-hidden="true"></i></span></div>';const n=e.querySelector("input");n.min="0",n.max=a.dataset.outstandingBalance,n.step="0.01",n.addEventListener("change",s),a.querySelector("td:last-child").insertAdjacentElement("beforebegin",e)}}};let o=exports.batchTransactions;(()=>{const t=new Set;for(const e of o)t.add(e.batchDateString);(n=[...t.values()]).sort()})();const r=()=>{const t=a.querySelectorAll("input[data-field='transactionAmount']");for(const e of t)e.value="";const e=new Map,n=new Map;for(const t of o){const s=a.querySelector("tr[data-licence-id='"+t.licenceId.toString()+"']").querySelector("td[data-batch-date-string='"+t.batchDateString+"']").querySelector("input"),c=Number.parseFloat(s.value)||0;s.value=(c+t.transactionAmount).toFixed(2),s.classList.remove("has-background-danger-light"),s.checkValidity()||s.classList.add("has-background-danger-light"),e.has(t.licenceId)?e.set(t.licenceId,e.get(t.licenceId)+t.transactionAmount):e.set(t.licenceId,t.transactionAmount),n.has(t.batchDateString)?n.set(t.batchDateString,n.get(t.batchDateString)+t.transactionAmount):n.set(t.batchDateString,t.transactionAmount)}const s=a.querySelectorAll("tbody tr[data-licence-id]");for(const t of s){const a=Number.parseInt(t.dataset.licenceId,10),n=Number.parseFloat(t.dataset.outstandingBalance),s=e.has(a)?e.get(a):0,c=t.querySelector("td:last-child");c.textContent="$"+s.toFixed(2),c.classList.remove("has-background-success-light","has-background-danger-light"),n===s?c.classList.add("has-background-success-light"):n<s&&c.classList.add("has-background-danger-light")}const c=a.querySelectorAll("tfoot th[data-batch-date-string]");for(const t of c){const e=t.dataset.batchDateString;t.textContent=n.has(e)?"$"+n.get(e).toFixed(2):"$0.00"}};c(),r(),document.querySelector("#is-add-batch-button").addEventListener("click",t=>{let e,a;t.preventDefault();const s=t=>{t.preventDefault();const s=e.value;n.includes(s)?bulmaJS.alert({title:"Batch Date Already Included",message:"To add a new batch, choose a new date."}):(n.push(s),n.sort(),a(),c(),r())};cityssm.openHtmlModal("batchBuilder-addBatch",{onshown:(t,n)=>{e=t.querySelector("#addBatch--batchDateString"),a=n,t.querySelector("#form--addBatch").addEventListener("submit",s)}})})})();