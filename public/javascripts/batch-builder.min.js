"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),(()=>{const t=exports.glm,e=document.querySelector("main").dataset.urlPrefix,a=exports.licenceAlias,s=document.querySelector("#table--transactionBatches");let n=[];const c=t=>{t.preventDefault();const a=t.currentTarget.closest("th").dataset.batchDateString;bulmaJS.confirm({title:"Clear and Remove Batch",message:"Are you sure you want to clear all amounts in this batch?",contextualColorName:"warning",okButton:{text:"Yes, Clear the Batch",callbackFunction:()=>{cityssm.postJSON(e+"/batches/doClearBatchTransactions",{batchDateString:a},t=>{t.success&&(r=t.batchTransactions,i(),l(),d())})}}})},o=t=>{t.preventDefault();const s=t.currentTarget,n=s.value,c=s.closest("td").dataset.batchDateString,o=s.closest("tr").dataset.licenceId;cityssm.postJSON(e+"/batches/doCreateOrUpdateBatchTransaction",{licenceId:o,batchDateString:c,transactionAmount:n},t=>{if(t.success&&(r=t.batchTransactions,d()),t.message){const e=s.closest("tr").dataset.licenceNumber;bulmaJS.alert({title:a+" #"+e+", Batch "+c,message:t.message,contextualColorName:t.success?"warning":"danger"})}})},l=()=>{const a=s.querySelectorAll("[data-batch-date-string]");for(const t of a)t.remove();const l=s.querySelectorAll("tbody tr");for(const a of n){const n=document.createElement("th");n.dataset.batchDateString=a,n.innerHTML='<div class="level is-mobile mb-0"><div class="level-left"><div class="level-item">'+a+'</div></div><div class="level-right"><div class="level-item"><div class="dropdown is-up is-right has-text-weight-normal"><div class="dropdown-trigger"><button class="button is-small is-white has-tooltip-left" data-tooltip="Batch Options" type="button" aria-label="Batch Options"><i class="fas fa-bars" aria-hidden="true"></i></button></div><div class="dropdown-menu"><div class="dropdown-content"><a class="dropdown-item" href="'+e+"/reports/licenceTransactions-byDate?batchDateString="+a+'"><span class="icon"><i class="fas fa-file-csv" aria-hidden="true"></i></span> <span>Transaction Report</span></a><hr class="dropdown-divider"><a class="dropdown-item is-clear-batch-button" role="button" href="#"><span class="icon"><i class="fas fa-trash" aria-hidden="true"></i></span> <span>Clear and Remove Batch</span></a></div></div></div></div></div></div><div class="has-text-centered is-size-7">'+t.getDayName(a)+"</div>",n.querySelector(".is-clear-batch-button").addEventListener("click",c),s.querySelector("thead th:last-child").insertAdjacentElement("beforebegin",n);const r=document.createElement("th");r.className="has-text-right",r.dataset.batchDateString=a,s.querySelector("tfoot th:last-child").insertAdjacentElement("beforebegin",r);for(const t of l){const e=document.createElement("td");e.dataset.batchDateString=a,e.innerHTML='<div class="control has-icons-left"><input class="input is-small has-text-right" data-field="transactionAmount" type="number" min="0" onwheel="return false" /><span class="icon is-small is-left"><i class="fas fa-dollar-sign" aria-hidden="true"></i></span></div>';const s=e.querySelector("input");s.min="0",s.max=t.dataset.outstandingBalance,s.step="0.01",s.addEventListener("change",o),t.querySelector("td:last-child").insertAdjacentElement("beforebegin",e)}}bulmaJS.init(s)};let r=exports.batchTransactions;const i=()=>{const t=new Set;for(const e of r)t.add(e.batchDateString);(n=[...t.values()]).sort()};i();const d=()=>{const t=s.querySelectorAll("input[data-field='transactionAmount']");for(const e of t)e.value="";const e=new Map,a=new Map;for(const t of r){const n=s.querySelector("tr[data-licence-id='"+t.licenceId.toString()+"']").querySelector("td[data-batch-date-string='"+t.batchDateString+"']").querySelector("input"),c=Number.parseFloat(n.value)||0;n.value=(c+t.transactionAmount).toFixed(2),n.classList.remove("has-background-danger-light"),n.checkValidity()||n.classList.add("has-background-danger-light"),e.has(t.licenceId)?e.set(t.licenceId,e.get(t.licenceId)+t.transactionAmount):e.set(t.licenceId,t.transactionAmount),a.has(t.batchDateString)?a.set(t.batchDateString,a.get(t.batchDateString)+t.transactionAmount):a.set(t.batchDateString,t.transactionAmount)}const n=s.querySelectorAll("tbody tr[data-licence-id]");for(const t of n){const a=Number.parseInt(t.dataset.licenceId,10),s=Number.parseFloat(t.dataset.outstandingBalance),n=e.has(a)?e.get(a):0,c=t.querySelector("td:last-child");c.textContent="$"+n.toFixed(2),c.classList.remove("has-background-success-light","has-background-danger-light"),s.toFixed(2)===n.toFixed(2)?c.classList.add("has-background-success-light"):s<n&&c.classList.add("has-background-danger-light")}const c=s.querySelectorAll("tfoot th[data-batch-date-string]");for(const t of c){const e=t.dataset.batchDateString;t.textContent=a.has(e)?"$"+a.get(e).toFixed(2):"$0.00"}};l(),d();const u=t=>{t.preventDefault();const a=t.currentTarget.closest("tr"),s=a.dataset.licenceId,c=a.dataset.outstandingBalance,o=()=>{cityssm.postJSON(e+"/batches/doSplitOutstandingBalances",{licenceOutstandingBalances:[{licenceId:s,outstandingBalance:c}],batchDateStrings:n},t=>{t.success&&(r=t.batchTransactions,d())})};0===n.length?bulmaJS.alert({message:"There are no batches available."}):bulmaJS.confirm({title:"Split Balance Across Batches",message:"Are you sure you want to evenly split the outstanding balance across "+n.length+" batch"+(1===n.length?"":"es")+"?",okButton:{text:"Yes, Split the Balance",callbackFunction:o}})},h=document.querySelectorAll(".is-split-outstanding-balance-button");for(const t of h)t.addEventListener("click",u);document.querySelector(".is-split-outstanding-balances-button").addEventListener("click",t=>{t.preventDefault();const a=s.querySelectorAll("tbody tr"),c=[];for(const t of a)c.push({licenceId:t.dataset.licenceId,outstandingBalance:t.dataset.outstandingBalance});const o=()=>{cityssm.postJSON(e+"/batches/doSplitOutstandingBalances",{licenceOutstandingBalances:c,batchDateStrings:n},t=>{t.success&&(r=t.batchTransactions,d())})};0===n.length?bulmaJS.alert({message:"There are no batches available."}):bulmaJS.confirm({title:"Split Balances Across Batches",message:"Are you sure you want to evenly split the outstanding balances across "+n.length+" batch"+(1===n.length?"":"es")+"?",okButton:{text:"Yes, Split the Balance",callbackFunction:o}})});const b=t=>{t.preventDefault();const a=t.currentTarget.closest("tr").dataset.licenceId;bulmaJS.confirm({title:"Clear All Transactions",message:"Are you sure you want to clear all transaction amounts in this row?",contextualColorName:"warning",okButton:{text:"Yes, Clear All Transactions",callbackFunction:()=>{cityssm.postJSON(e+"/batches/doClearLicenceBatchTransactions",{licenceIds:[a]},t=>{t.success&&(r=t.batchTransactions,d())})}}})},g=document.querySelectorAll(".is-clear-licence-button");for(const t of g)t.addEventListener("click",b);document.querySelector(".is-clear-licences-button").addEventListener("click",t=>{t.preventDefault();const a=s.querySelectorAll("tbody tr"),n=[];for(const t of a)n.push(t.dataset.licenceId);bulmaJS.confirm({title:"Clear All Transactions",message:"Are you sure you want to clear all transaction amounts?",contextualColorName:"warning",okButton:{text:"Yes, Clear All Transactions",callbackFunction:()=>{cityssm.postJSON(e+"/batches/doClearLicenceBatchTransactions",{licenceIds:n},t=>{t.success&&(r=t.batchTransactions,d())})}}})}),document.querySelector("#is-add-batch-button").addEventListener("click",t=>{let e,a;t.preventDefault();const s=t=>{t.preventDefault();const s=e.value;n.includes(s)?bulmaJS.alert({title:"Batch Date Already Included",message:"To add a new batch, choose a new date."}):(n.push(s),n.sort(),a(),l(),d())};cityssm.openHtmlModal("batchBuilder-addBatch",{onshown:(t,n)=>{e=t.querySelector("#addBatch--batchDateString"),a=n,t.querySelector("#form--addBatch").addEventListener("submit",s)},onremoved:()=>{bulmaJS.toggleHtmlClipped()}})})})();