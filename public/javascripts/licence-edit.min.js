"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),(()=>{const e=exports.glm,t=document.querySelector("main").dataset.urlPrefix,n=exports.licenceAlias,c=document.querySelector("#licenceEdit--licenceId").value,a=""===c,s=(t,n,c)=>{const a=t.value,s=n.value;""!==a?e.getBankName(a,s,e=>{c.value=e&&""!==e?e:"Institution Not Found ("+a+")"}):c.value=""};let r=!1;const o=()=>{r=!0,cityssm.enableNavBlocker()},i=document.querySelector("#form--licenceEdit");i.addEventListener("submit",e=>{e.preventDefault();const c=t+"/licences/"+(a?"doCreateLicence":"doUpdateLicence");cityssm.postJSON(c,e.currentTarget,e=>{e.success?(r=!1,cityssm.disableNavBlocker(),a?window.location.href=t+"/licences/"+e.licenceId.toString()+"/edit":bulmaJS.alert({message:n+" Updated Successfully",contextualColorName:"success"})):bulmaJS.alert({title:"Error Updating "+n,message:e.errorMessage,contextualColorName:"danger"})})});const l=i.querySelectorAll("input, select");for(const e of l)e.hasAttribute("name")&&e.addEventListener("change",o);const u=e=>{e.preventDefault();const t=e.currentTarget.closest(".field").querySelector("input");t.readOnly=!1,t.focus()},d=i.querySelectorAll(".is-unlock-button");for(const e of d)e.addEventListener("click",u);a&&document.querySelector("#is-cancel-related-licence-id-button")&&document.querySelector("#is-cancel-related-licence-id-button").addEventListener("click",e=>{e.preventDefault(),e.currentTarget.closest(".message").remove()});const m=document.querySelector("#licenceEdit--bankInstitutionNumber"),p=document.querySelector("#licenceEdit--bankTransitNumber");if(exports.includeBatches){const e=e=>{e.preventDefault();const t=document.querySelector("#licenceEdit--bankName");s(m,p,t)};m.addEventListener("change",e),p.addEventListener("change",e)}const y=document.querySelector("#licenceEdit--licenceCategoryKey"),v=document.querySelector("#licenceEdit--isRenewal"),g=document.querySelector("#licenceEdit--startDateString"),b=document.querySelector("#licenceEdit--endDateString"),h=()=>{const e=g.valueAsDate;if(b.readOnly=!0,!e||""===y.value)return void(b.value="");const n=y.selectedOptions[0],c=n.dataset.licenceLengthFunction;if(""===c){const t=Number.parseInt(n.dataset.licenceLengthYears),c=Number.parseInt(n.dataset.licenceLengthMonths),a=Number.parseInt(n.dataset.licenceLengthDays);t>0&&(e.setFullYear(e.getFullYear()+t),e.setDate(e.getDate()-1)),c>0&&(e.setMonth(e.getMonth()+c),e.setDate(e.getDate()-1)),a>0&&e.setDate(e.getDate()+a-1),b.valueAsDate=e}else cityssm.postJSON(t+"/licences/doGetLicenceEndDate",{licenceLengthFunction:c,startDateString:g.value},e=>{e.success?b.value=e.endDateString:bulmaJS.alert({title:"End Date Error",message:e.errorMessage,contextualColorName:"danger"})})};let S;a&&(y.addEventListener("change",h),""!==y.value&&h()),g.addEventListener("change",h);const f=()=>{const e=document.querySelector("#licenceEdit--licenceFee"),t=document.querySelector("#licenceEdit--replacementFee");if(!S||0===S.licenceCategoryFees.length)return e.value="",void(t.value="");e.value=v.checked?S.licenceCategoryFees[0].renewalFee.toFixed(2):S.licenceCategoryFees[0].licenceFee.toFixed(2),t.value=S.licenceCategoryFees[0].replacementFee.toFixed(2)},q=()=>{(()=>{const e=document.querySelector("#container--licenceFields");if(!S||0===S.licenceCategoryFields.length)return e.innerHTML="",void e.classList.add("is-hidden");e.classList.remove("is-hidden"),e.innerHTML='<h2 class="panel-heading">Fields</h2>';const t=[];for(const n of S.licenceCategoryFields){const c=document.createElement("div");c.className="panel-block is-block",c.innerHTML='<div class="field"><label class="label"></label><div class="control"><input class="input" type="text" /></div></div>';const a="licenceFieldEdit--"+n.licenceFieldKey,s=c.querySelector("label");s.setAttribute("for",a),s.textContent=n.licenceField;const r=c.querySelector("input");if(r.id=a,r.name="field--"+n.licenceFieldKey,r.minLength=n.minimumLength,r.maxLength=n.maximumLength,""!==n.pattern&&(r.pattern=n.pattern),n.isRequired&&(r.required=!0),""!==n.licenceFieldDescription){const e=document.createElement("p");e.className="help",e.textContent=n.licenceFieldDescription,c.append(e)}e.append(c),t.push(n.licenceFieldKey)}const n=document.createElement("input");n.type="hidden",n.name="licenceFieldKeys",n.value=t.join(","),e.append(n)})(),(()=>{const e=document.querySelector("#container--licenceApprovals");if(!S||0===S.licenceCategoryApprovals.length)return e.innerHTML="",void e.classList.add("is-hidden");e.classList.remove("is-hidden"),e.innerHTML='<h2 class="panel-heading">Approvals</h2>';const t=[];for(const n of S.licenceCategoryApprovals){const c=document.createElement("div");c.className="panel-block is-block",c.innerHTML='<div class="facheck"><input type="checkbox" /><label></label></div>';const a="licenceApprovalEdit--"+n.licenceApprovalKey,s=c.querySelector("label");s.setAttribute("for",a),s.textContent=n.licenceApproval;const r=c.querySelector("input");if(r.id=a,r.name="approval--"+n.licenceApprovalKey,r.dataset.isRequiredForNew=n.isRequiredForNew?"true":"false",r.dataset.isRequiredForRenewal=n.isRequiredForRenewal?"true":"false",(v.checked&&n.isRequiredForRenewal||!v.checked&&n.isRequiredForNew)&&(r.required=!0),""!==n.licenceApprovalDescription){const e=document.createElement("p");e.className="help",e.textContent=n.licenceApprovalDescription,c.append(e)}e.append(c),t.push(n.licenceApprovalKey)}const n=document.createElement("input");n.type="hidden",n.name="licenceApprovalKeys",n.value=t.join(","),e.append(n)})(),f()},A=()=>{if(""===y.value)return S=void 0,void q();cityssm.postJSON(t+"/licences/doGetLicenceCategory",{licenceCategoryKey:y.value},e=>{S=e.licenceCategory,q()})};a?(y.addEventListener("change",A),""!==y.value&&A()):S=exports.licenceCategory,v.addEventListener("change",()=>{const e=document.querySelector("#container--licenceApprovals").querySelectorAll("input");for(const t of e)t.required=!!(v.checked&&"true"===t.dataset.isRequiredForRenewal||!v.checked&&"true"===t.dataset.isRequiredForNew);f()});const w=document.querySelector("#table--licenceTransactions");let L;const E=()=>{const e=document.querySelector("#licenceEdit--licenceFee").value,t=w.querySelectorAll("tfoot th")[1].textContent.slice(1);return Math.max(Number.parseFloat(e)-Number.parseFloat(t),0)},N=e=>{e.preventDefault();const n=e.currentTarget.closest("tr").dataset.transactionIndex;bulmaJS.confirm({title:"Delete Transaction",message:"Are you sure you want to delete this transaction? In the event of a refund, it may be better to create a new negative transaction.",contextualColorName:"danger",okButton:{text:"Yes, Delete the Transaction",callbackFunction:()=>{cityssm.postJSON(t+"/licences/doDeleteLicenceTransaction",{licenceId:c,transactionIndex:n},e=>{e.success&&(L=e.licenceTransactions,k())})}}})},k=()=>{const e=w.querySelector("tbody");e.innerHTML="";let t=0;const n=cityssm.dateToString(new Date);for(const c of L){const a=document.createElement("tr");a.dataset.transactionIndex=c.transactionIndex.toString(),a.innerHTML="<td>"+c.transactionDateString+'<br /><div class="tags">'+(n<c.transactionDateString?'<span class="tag is-warning">Upcoming</span>':"")+(c.batchDate?'<span class="tag is-info">Batch Transaction</span>':"")+(!c.batchDate||c.externalReceiptNumber&&""!==c.externalReceiptNumber?"":'<span class="tag is-warning">Unconfirmed</span>')+'</div></td><td class="has-text-right">$'+c.transactionAmount.toFixed(2)+'</td><td><button class="button is-small is-danger is-inverted" type="button"><i class="fas fa-trash" aria-label="Delete Transaction"></i></button></td>',a.querySelector("button").addEventListener("click",N),e.append(a),t+=c.transactionAmount}w.querySelectorAll("tfoot th")[1].textContent="$"+t.toFixed(2)},D=e=>{e.preventDefault();const t=e.currentTarget.closest(".modal"),n=t.querySelector("#transactionAdd--bankInstitutionNumber"),c=t.querySelector("#transactionAdd--bankTransitNumber"),a=t.querySelector("#transactionAdd--bankName");s(n,c,a)},F=n=>{let a,s;n.preventDefault();const r=e=>{e.preventDefault(),cityssm.postJSON(t+"/licences/doAddLicenceTransaction",e.currentTarget,e=>{e.success&&(L=e.licenceTransactions,k(),s())})},o=e=>{e.preventDefault();const t=e.currentTarget.dataset.spanId;a.querySelector("#transactionAdd--transactionAmount").value=a.querySelector("#"+t).textContent};cityssm.openHtmlModal("transaction-add",{onshow:t=>{e.populateAliases(t),t.querySelector("#transactionAdd--licenceId").value=c;const n=document.querySelector("#licenceEdit--licenceFee").value;t.querySelector("#transactionAdd--licenceFee").textContent=n,t.querySelector("#transactionAdd--replacementFee").textContent=document.querySelector("#licenceEdit--replacementFee").value;const a=E();t.querySelector("#transactionAdd--outstandingBalance").textContent=a.toFixed(2),t.querySelector("#transactionAdd--transactionAmount").value=a>0?a.toFixed(2):document.querySelector("#licenceEdit--replacementFee").value},onshown:(e,t)=>{a=e,s=t;const n=e.querySelectorAll(".is-set-transaction-amount-button");for(const e of n)e.addEventListener("click",o);const c=e.querySelector("#transactionAdd--bankInstitutionNumber"),i=e.querySelector("#transactionAdd--bankTransitNumber");e.querySelector("button.is-more-fields-button").addEventListener("click",t=>{t.preventDefault(),t.currentTarget.remove();let n=".is-more-fields";exports.includeBatches&&(n+=", .is-more-fields-batch");for(const t of e.querySelectorAll(n))t.classList.remove("is-hidden");exports.includeBatches&&(c.addEventListener("change",D),i.addEventListener("change",D))}),exports.includeBatches&&e.querySelector("button.is-copy-bank-numbers-button").addEventListener("click",t=>{t.preventDefault(),c.value=m.value,i.value=p.value,e.querySelector("#transactionAdd--bankName").value=document.querySelector("#licenceEdit--bankName").value,e.querySelector("#transactionAdd--bankAccountNumber").value=document.querySelector("#licenceEdit--bankAccountNumber").value}),e.querySelector("#form--transactionAdd").addEventListener("submit",r)}})};if(!a){document.querySelector("#button--addTransaction").addEventListener("click",F);const e=document.querySelectorAll(".is-delete-transaction-button");for(const t of e)t.addEventListener("click",N)}const x=document.querySelector("#is-issue-licence-button");if(x){const e=()=>{cityssm.postJSON(t+"/licences/doIssueLicence",{licenceId:c},e=>{e.success&&window.location.reload()})};x.addEventListener("click",t=>{t.preventDefault(),r?bulmaJS.alert({title:n+" Has Unsaved Changes",message:"Please save your "+n.toLowerCase()+" changes before issuing the "+n.toLowerCase()+".",contextualColorName:"warning"}):E()>0?bulmaJS.confirm({title:n+" Has an Outstanding Balance",message:"Are you sure you want to issue this "+n.toLowerCase()+" with an outstanding balance?",contextualColorName:"warning",okButton:{text:"Yes, Issue with Outstanding Balance",callbackFunction:e}}):g.value<cityssm.dateToString(new Date)?bulmaJS.confirm({title:n+" Has a Start Date in the Past",message:"Are you sure you want to issue this "+n.toLowerCase()+" with a start date in the past?",contextualColorName:"warning",okButton:{text:"Yes, Issue with a Past Start Date",callbackFunction:e}}):bulmaJS.confirm({title:"Issue "+n,message:"Are you sure you want to issue this "+n.toLowerCase()+"?",contextualColorName:"info",okButton:{text:"Yes, Issue "+n,callbackFunction:e}})})}if(!a&&!x){const e=()=>{const e=new URL(window.location.protocol+"//"+window.location.host+t+"/licences/new");e.searchParams.append("licenceCategoryKey",y.value),e.searchParams.append("isRenewal","true"),e.searchParams.append("licenseeName",document.querySelector("#licenceEdit--licenseeName").value),e.searchParams.append("licenseeBusinessName",document.querySelector("#licenceEdit--licenseeBusinessName").value),e.searchParams.append("licenseeAddress1",document.querySelector("#licenceEdit--licenseeAddress1").value),e.searchParams.append("licenseeAddress2",document.querySelector("#licenceEdit--licenseeAddress2").value),e.searchParams.append("licenseeCity",document.querySelector("#licenceEdit--licenseeCity").value),e.searchParams.append("licenseeProvince",document.querySelector("#licenceEdit--licenseeProvince").value),e.searchParams.append("licenseePostalCode",document.querySelector("#licenceEdit--licenseePostalCode").value),e.searchParams.append("bankInstitutionNumber",m.value),e.searchParams.append("bankTransitNumber",p.value),e.searchParams.append("bankAccountNumber",document.querySelector("#licenceEdit--bankAccountNumber").value);let n=b.valueAsDate;n.setDate(n.getDate()+1),n.getTime()<Date.now()&&(n=new Date),e.searchParams.append("startDateString",cityssm.dateToString(n)),window.location.href=e.toString()};document.querySelector("#is-renew-licence-button").addEventListener("click",t=>{t.preventDefault(),bulmaJS.confirm({title:"Renew "+n,message:"Are you sure you want to renew this "+n.toLowerCase()+"?",okButton:{text:"Yes, Renew this "+n,callbackFunction:e}})})}a||document.querySelector("#is-delete-licence-button").addEventListener("click",e=>{e.preventDefault();const a=!x,s=b.value<cityssm.dateToString(new Date);bulmaJS.confirm({title:"Delete "+n,message:"<p>Are you sure you want to delete this "+n.toLowerCase()+"?</p>"+(a?"<p>Note that <strong>this "+n.toLowerCase()+" has been issued</strong>, and deleting it may cause confusion.</p>":""),messageIsHtml:!0,contextualColorName:s?"info":"warning",okButton:{text:"Yes, Delete "+n,callbackFunction:()=>{cityssm.postJSON(t+"/licences/doDeleteLicence",{licenceId:c},e=>{e.success&&(window.location.href=t+"/licences")})}}})})})();