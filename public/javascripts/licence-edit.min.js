"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),(()=>{const e=document.querySelector("main").dataset.urlPrefix,t=exports.licenceAlias,n=document.querySelector("#licenceEdit--licenceId").value,c=""===n;let a=!1;const s=()=>{a=!0,cityssm.enableNavBlocker()},o=document.querySelector("#form--licenceEdit");o.addEventListener("submit",t=>{t.preventDefault();const n=e+"/licences/"+(c?"doCreateLicence":"doUpdateLicence");cityssm.postJSON(n,t.currentTarget,t=>{t.success?(a=!1,cityssm.disableNavBlocker(),c?window.location.href=e+"/licences/"+t.licenceId.toString()+"/edit":bulmaJS.alert({message:"Licence Updated Successfully",contextualColorName:"success"})):bulmaJS.alert({title:"Error Updating Licence",message:t.errorMessage,contextualColorName:"danger"})})});const i=o.querySelectorAll("input, select");for(const e of i)e.hasAttribute("name")&&e.addEventListener("change",s);const r=e=>{e.preventDefault();const t=e.currentTarget.closest(".field").querySelector("input");t.readOnly=!1,t.focus()},l=o.querySelectorAll(".is-unlock-button");for(const e of l)e.addEventListener("click",r);const d=document.querySelector("#licenceEdit--licenceCategoryKey"),u=document.querySelector("#licenceEdit--isRenewal"),m=document.querySelector("#licenceEdit--startDateString"),p=document.querySelector("#licenceEdit--endDateString"),y=()=>{const t=m.valueAsDate;if(p.readOnly=!0,!t||""===d.value)return void(p.value="");const n=d.selectedOptions[0],c=n.dataset.licenceLengthFunction;if(""===c){const e=Number.parseInt(n.dataset.licenceLengthYears),c=Number.parseInt(n.dataset.licenceLengthMonths),a=Number.parseInt(n.dataset.licenceLengthDays);e>0&&(t.setFullYear(t.getFullYear()+e),t.setDate(t.getDate()-1)),c>0&&(t.setMonth(t.getMonth()+c),t.setDate(t.getDate()-1)),a>0&&t.setDate(t.getDate()+a-1),p.valueAsDate=t}else cityssm.postJSON(e+"/licences/doGetLicenceEndDate",{licenceLengthFunction:c,startDateString:m.value},e=>{e.success?p.value=e.endDateString:bulmaJS.alert({title:"End Date Error",message:e.errorMessage,contextualColorName:"danger"})})};let v;c&&(d.addEventListener("change",y),""!==d.value&&y()),m.addEventListener("change",y);const g=()=>{const e=document.querySelector("#licenceEdit--licenceFee"),t=document.querySelector("#licenceEdit--replacementFee");if(!v||0===v.licenceCategoryFees.length)return e.value="",void(t.value="");e.value=u.checked?v.licenceCategoryFees[0].renewalFee.toFixed(2):v.licenceCategoryFees[0].licenceFee.toFixed(2),t.value=v.licenceCategoryFees[0].replacementFee.toFixed(2)},h=()=>{(()=>{const e=document.querySelector("#container--licenceFields");if(!v||0===v.licenceCategoryFields.length)return e.innerHTML="",void e.classList.add("is-hidden");e.classList.remove("is-hidden"),e.innerHTML='<h2 class="panel-heading">Fields</h2>';const t=[];for(const n of v.licenceCategoryFields){const c=document.createElement("div");c.className="panel-block is-block",c.innerHTML='<div class="field"><label class="label"></label><div class="control"><input class="input" type="text" /></div></div>';const a="licenceFieldEdit--"+n.licenceFieldKey,s=c.querySelector("label");s.setAttribute("for",a),s.textContent=n.licenceField;const o=c.querySelector("input");if(o.id=a,o.name="field--"+n.licenceFieldKey,o.minLength=n.minimumLength,o.maxLength=n.maximumLength,""!==n.pattern&&(o.pattern=n.pattern),n.isRequired&&(o.required=!0),""!==n.licenceFieldDescription){const e=document.createElement("p");e.className="help",e.textContent=n.licenceFieldDescription,c.append(e)}e.append(c),t.push(n.licenceFieldKey)}const n=document.createElement("input");n.type="hidden",n.name="licenceFieldKeys",n.value=t.join(","),e.append(n)})(),(()=>{const e=document.querySelector("#container--licenceApprovals");if(!v||0===v.licenceCategoryApprovals.length)return e.innerHTML="",void e.classList.add("is-hidden");e.classList.remove("is-hidden"),e.innerHTML='<h2 class="panel-heading">Approvals</h2>';const t=[];for(const n of v.licenceCategoryApprovals){const c=document.createElement("div");c.className="panel-block is-block",c.innerHTML='<div class="facheck"><input type="checkbox" /><label></label></div>';const a="licenceApprovalEdit--"+n.licenceApprovalKey,s=c.querySelector("label");s.setAttribute("for",a),s.textContent=n.licenceApproval;const o=c.querySelector("input");if(o.id=a,o.name="approval--"+n.licenceApprovalKey,o.dataset.isRequiredForNew=n.isRequiredForNew?"true":"false",o.dataset.isRequiredForRenewal=n.isRequiredForRenewal?"true":"false",(u.checked&&n.isRequiredForRenewal||!u.checked&&n.isRequiredForNew)&&(o.required=!0),""!==n.licenceApprovalDescription){const e=document.createElement("p");e.className="help",e.textContent=n.licenceApprovalDescription,c.append(e)}e.append(c),t.push(n.licenceApprovalKey)}const n=document.createElement("input");n.type="hidden",n.name="licenceApprovalKeys",n.value=t.join(","),e.append(n)})(),g()},S=()=>{if(""===d.value)return v=void 0,void h();cityssm.postJSON(e+"/licences/doGetLicenceCategory",{licenceCategoryKey:d.value},e=>{v=e.licenceCategory,h()})};c?(d.addEventListener("change",S),""!==d.value&&S()):v=exports.licenceCategory,u.addEventListener("change",()=>{const e=document.querySelector("#container--licenceApprovals").querySelectorAll("input");for(const t of e)t.required=!!(u.checked&&"true"===t.dataset.isRequiredForRenewal||!u.checked&&"true"===t.dataset.isRequiredForNew);g()});const f=document.querySelector("#table--licenceTransactions");let q;const b=()=>{const e=document.querySelector("#licenceEdit--licenceFee").value,t=f.querySelectorAll("tfoot th")[1].textContent.slice(1);return Math.max(Number.parseFloat(e)-Number.parseFloat(t),0)},w=t=>{t.preventDefault();const c=t.currentTarget.closest("tr").dataset.transactionIndex;bulmaJS.confirm({title:"Delete Transaction",message:"Are you sure you want to delete this transaction? In the event of a refund, it may be better to create a new negative transaction.",contextualColorName:"danger",okButton:{text:"Yes, Delete the Transaction",callbackFunction:()=>{cityssm.postJSON(e+"/licences/doDeleteLicenceTransaction",{licenceId:n,transactionIndex:c},e=>{e.success&&(q=e.licenceTransactions,L())})}}})},L=()=>{const e=f.querySelector("tbody");e.innerHTML="";let t=0;for(const n of q){const c=document.createElement("tr");c.dataset.transactionIndex=n.transactionIndex.toString(),c.innerHTML="<td>"+n.transactionDateString+'</td><td class="has-text-right">$'+n.transactionAmount.toFixed(2)+'</td><td><button class="button is-small is-danger is-inverted" type="button"><i class="fas fa-trash" aria-label="Delete Transaction"></i></button></td>',c.querySelector("button").addEventListener("click",w),e.append(c),t+=n.transactionAmount}f.querySelectorAll("tfoot th")[1].textContent="$"+t.toFixed(2)},F=t=>{let c,a;t.preventDefault();const s=t=>{t.preventDefault(),cityssm.postJSON(e+"/licences/doAddLicenceTransaction",t.currentTarget,e=>{e.success&&(q=e.licenceTransactions,L(),a())})},o=e=>{e.preventDefault();const t=e.currentTarget.dataset.spanId;c.querySelector("#transactionAdd--transactionAmount").value=c.querySelector("#"+t).textContent};cityssm.openHtmlModal("transaction-add",{onshow:e=>{e.querySelector("#transactionAdd--licenceId").value=n;const t=document.querySelector("#licenceEdit--licenceFee").value;e.querySelector("#transactionAdd--licenceFee").textContent=t,e.querySelector("#transactionAdd--replacementFee").textContent=document.querySelector("#licenceEdit--replacementFee").value;const c=b();e.querySelector("#transactionAdd--outstandingBalance").textContent=c.toFixed(2),e.querySelector("#transactionAdd--transactionAmount").value=c>0?c.toFixed(2):document.querySelector("#licenceEdit--replacementFee").value},onshown:(e,t)=>{c=e,a=t;const n=e.querySelectorAll(".is-set-transaction-amount-button");for(const e of n)e.addEventListener("click",o);e.querySelector("#form--transactionAdd").addEventListener("submit",s)}})};if(!c){document.querySelector("#button--addTransaction").addEventListener("click",F);const e=document.querySelectorAll(".is-delete-transaction-button");for(const t of e)t.addEventListener("click",w)}const A=document.querySelector("#is-issue-licence-button");if(A){const c=()=>{cityssm.postJSON(e+"/licences/doIssueLicence",{licenceId:n},e=>{e.success&&window.location.reload()})};A.addEventListener("click",e=>{e.preventDefault(),a?bulmaJS.alert({title:t+" Has Unsaved Changes",message:"Please save your "+t.toLowerCase()+" changes before issuing the "+t.toLowerCase()+".",contextualColorName:"warning"}):b()>0?bulmaJS.confirm({title:t+" Has an Outstanding Balance",message:"Are you sure you want to issue this "+t.toLowerCase()+" with an outstanding balance?",contextualColorName:"warning",okButton:{text:"Yes, Issue with Outstanding Balance",callbackFunction:c}}):m.value<cityssm.dateToString(new Date)?bulmaJS.confirm({title:t+" Has a Start Date in the Past",message:"Are you sure you want to issue this "+t.toLowerCase()+" with a start date in the past?",contextualColorName:"warning",okButton:{text:"Yes, Issue with a Past Start Date",callbackFunction:c}}):bulmaJS.confirm({title:"Issue "+t,message:"Are you sure you want to issue this "+t.toLowerCase()+"?",contextualColorName:"info",okButton:{text:"Yes, Issue "+t,callbackFunction:c}})})}if(!c&&!A){const n=()=>{const t=new URL(window.location.protocol+"//"+window.location.host+e+"/licences/new");t.searchParams.append("licenceCategoryKey",d.value),t.searchParams.append("isRenewal","true"),t.searchParams.append("licenseeName",document.querySelector("#licenceEdit--licenseeName").value),t.searchParams.append("licenseeBusinessName",document.querySelector("#licenceEdit--licenseeBusinessName").value),t.searchParams.append("licenseeAddress1",document.querySelector("#licenceEdit--licenseeAddress1").value),t.searchParams.append("licenseeAddress2",document.querySelector("#licenceEdit--licenseeAddress2").value),t.searchParams.append("licenseeCity",document.querySelector("#licenceEdit--licenseeCity").value),t.searchParams.append("licenseeProvince",document.querySelector("#licenceEdit--licenseeProvince").value),t.searchParams.append("licenseePostalCode",document.querySelector("#licenceEdit--licenseePostalCode").value);let n=p.valueAsDate;n.setDate(n.getDate()+1),n.getTime()<Date.now()&&(n=new Date),t.searchParams.append("startDateString",cityssm.dateToString(n)),window.location.href=t.toString()};document.querySelector("#is-renew-licence-button").addEventListener("click",e=>{e.preventDefault(),bulmaJS.confirm({title:"Renew Licence",message:"Are you sure you want to renew this "+t.toLowerCase()+"?",okButton:{text:"Yes, Renew this "+t,callbackFunction:n}})})}c||document.querySelector("#is-delete-licence-button").addEventListener("click",c=>{c.preventDefault();const a=!A,s=p.value<cityssm.dateToString(new Date);bulmaJS.confirm({title:"Delete "+t,message:"<p>Are you sure you want to delete this "+t.toLowerCase()+"?</p>"+(a?"<p>Note that <strong>this "+t.toLowerCase()+" has been issued</strong>, and deleting it may cause confusion.</p>":""),messageIsHtml:!0,contextualColorName:s?"info":"warning",okButton:{text:"Yes, Delete "+t,callbackFunction:()=>{cityssm.postJSON(e+"/licences/doDeleteLicence",{licenceId:n},t=>{t.success&&(window.location.href=e+"/licences")})}}})})})();