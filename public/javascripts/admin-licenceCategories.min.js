"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),(()=>{const e=document.querySelector("main").dataset.urlPrefix;let t=exports.licenceCategories;const c=document.querySelector("#container--licenceCategories"),n=()=>{if(0===t.length)return void(c.innerHTML='<div class="message is-warning"><p class="message-body">There are no licence categories available.</p></div>');const e=document.createElement("div");e.className="panel";for(const c of t){const t=document.createElement("a");t.className="panel-block is-block",t.dataset.licenceCategoryKey=c.licenceCategoryKey,t.innerHTML="<strong>"+cityssm.escapeHTML(c.licenceCategory)+'</strong><br /><div class="columns"><div class="column has-text-centered">'+(c.hasEffectiveFee?'<i class="fas fa-check has-text-success"></i><br /><span class="is-size-7">Effective Fee</span>':'<i class="fas fa-exclamation-triangle has-text-danger"></i><br /><span class="is-size-7">No Effective Fee</span>')+'</div><div class="column has-text-centered">'+(""===c.printEJS?'<i class="fas fa-exclamation-triangle has-text-danger"></i><br /><span class="is-size-7">No Print Template</span>':'<i class="fas fa-check has-text-success"></i><br /><span class="is-size-7">Print Template</span>')+"</div></div>",t.addEventListener("click",q),e.append(t)}c.innerHTML="",c.append(e)};let i,a,r=!1;const l=t=>{let c;const n=t=>{t.preventDefault(),cityssm.postJSON(e+"/admin/doUpdateLicenceCategoryField",t.currentTarget,e=>{e.success&&(a=e.licenceCategoryFields,c(),u(),r=!0)})},i=()=>{cityssm.postJSON(e+"/admin/doDeleteLicenceCategoryField",{licenceFieldKey:t},e=>{e.success&&(a=e.licenceCategoryFields,u(),c(),r=!0)})},l=e=>{e.preventDefault(),bulmaJS.confirm({title:"Delete Licence Field",message:"Are you sure you want to delete this licence field?",contextualColorName:"warning",okButton:{text:"Yes, Delete It",callbackFunction:i}})},o=a.find(e=>e.licenceFieldKey===t);cityssm.openHtmlModal("licenceCategoryField-edit",{onshow:e=>{e.querySelector("#licenceCategoryFieldEdit--licenceFieldKey").value=t,e.querySelector("#licenceCategoryFieldEdit--licenceField").value=o.licenceField,e.querySelector("#licenceCategoryFieldEdit--licenceFieldDescription").value=o.licenceFieldDescription,o.isRequired&&(e.querySelector("#licenceCategoryFieldEdit--isRequired").checked=!0);const c=e.querySelector("#licenceCategoryFieldEdit--minimumLength"),n=e.querySelector("#licenceCategoryFieldEdit--maximumLength");c.value=o.minimumLength.toString(),c.addEventListener("keyup",()=>{n.min=c.value}),n.value=o.maximumLength.toString(),n.min=o.minimumLength.toString(),e.querySelector("#licenceCategoryFieldEdit--pattern").value=o.pattern,e.querySelector("#licenceCategoryFieldEdit--printKey").value=o.printKey},onshown:(e,t)=>{c=t,e.querySelector("#form--licenceCategoryFieldEdit").addEventListener("submit",n),e.querySelector(".is-delete-button").addEventListener("click",l),bulmaJS.init(e)}})},o=e=>{e.preventDefault();const t=e.currentTarget.dataset.licenceFieldKey;l(t)},s=e=>{e.dataTransfer.dropEffect="move";const t="licenceFieldKey:"+e.target.dataset.licenceFieldKey;e.dataTransfer.setData("text/plain",t)},d=e=>{if(e.dataTransfer.getData("text/plain").startsWith("licenceFieldKey:")){e.dataTransfer.getData("text/plain").slice("licenceFieldKey:".length)!==e.currentTarget.dataset.licenceFieldKey&&(e.preventDefault(),e.dataTransfer.dropEffect="move")}},p=t=>{t.preventDefault();const c=t.dataTransfer.getData("text/plain").slice("licenceFieldKey:".length),n=t.currentTarget.dataset.licenceFieldKey;cityssm.postJSON(e+"/admin/doMoveLicenceCategoryField",{licenceFieldKey_from:c,licenceFieldKey_to:n},e=>{a=e.licenceCategoryFields,u(),r=!0})},u=()=>{const e=i.querySelector("#container--licenceCategoryFields");if(0===a.length)e.innerHTML='<div class="message is-info"><p class="message-body">There are no additional fields captured with this licence.</p></div>';else{const t=document.createElement("div");t.className="panel";for(const e of a){const c=document.createElement("a");c.className="panel-block is-block",c.dataset.licenceFieldKey=e.licenceFieldKey,c.innerHTML='<div class="columns is-mobile"><div class="column"><h4>'+cityssm.escapeHTML(e.licenceField)+'</h4><p class="is-size-7">'+cityssm.escapeHTML(e.licenceFieldDescription)+"</p></div>"+(e.isRequired?'<div class="column is-narrow"><i class="fas fa-asterisk" aria-hidden="true"</i></div>':"")+"</div>",c.addEventListener("click",o),a.length>1&&(c.draggable=!0,c.addEventListener("dragstart",s),c.addEventListener("dragover",d),c.addEventListener("drop",p)),t.append(c)}e.innerHTML="",e.append(t)}};let y;const g=t=>{let c;const n=t=>{t.preventDefault(),cityssm.postJSON(e+"/admin/doUpdateLicenceCategoryApproval",t.currentTarget,e=>{e.success&&(y=e.licenceCategoryApprovals,c(),S(),r=!0)})},i=()=>{cityssm.postJSON(e+"/admin/doDeleteLicenceCategoryApproval",{licenceApprovalKey:t},e=>{e.success&&(y=e.licenceCategoryApprovals,S(),c(),r=!0)})},a=e=>{e.preventDefault(),bulmaJS.confirm({title:"Delete Licence Approval",message:"Are you sure you want to delete this licence approval?",contextualColorName:"warning",okButton:{text:"Yes, Delete It",callbackFunction:i}})},l=y.find(e=>e.licenceApprovalKey===t);cityssm.openHtmlModal("licenceCategoryApproval-edit",{onshow:e=>{e.querySelector("#licenceCategoryApprovalEdit--licenceApprovalKey").value=t,e.querySelector("#licenceCategoryApprovalEdit--licenceApproval").value=l.licenceApproval,e.querySelector("#licenceCategoryApprovalEdit--licenceApprovalDescription").value=l.licenceApprovalDescription,l.isRequiredForNew&&(e.querySelector("#licenceCategoryApprovalEdit--isRequiredForNew").checked=!0),l.isRequiredForRenewal&&(e.querySelector("#licenceCategoryApprovalEdit--isRequiredForRenewal").checked=!0),e.querySelector("#licenceCategoryApprovalEdit--printKey").value=l.printKey},onshown:(e,t)=>{c=t,e.querySelector("#form--licenceCategoryApprovalEdit").addEventListener("submit",n),e.querySelector(".is-delete-button").addEventListener("click",a),bulmaJS.init(e)}})},m=e=>{e.preventDefault();const t=e.currentTarget.dataset.licenceApprovalKey;g(t)},v=e=>{e.dataTransfer.dropEffect="move";const t="licenceApprovalKey:"+e.target.dataset.licenceApprovalKey;e.dataTransfer.setData("text/plain",t)},f=e=>{if(e.dataTransfer.getData("text/plain").startsWith("licenceApprovalKey:")){e.dataTransfer.getData("text/plain").slice("licenceApprovalKey:".length)!==e.currentTarget.dataset.licenceApprovalKey&&(e.preventDefault(),e.dataTransfer.dropEffect="move")}},C=t=>{t.preventDefault();const c=t.dataTransfer.getData("text/plain").slice("licenceApprovalKey:".length),n=t.currentTarget.dataset.licenceApprovalKey;cityssm.postJSON(e+"/admin/doMoveLicenceCategoryApproval",{licenceApprovalKey_from:c,licenceApprovalKey_to:n},e=>{y=e.licenceCategoryApprovals,S(),r=!0})},S=()=>{const e=i.querySelector("#container--licenceCategoryApprovals");if(0===y.length)e.innerHTML='<div class="message is-info"><p class="message-body">There are no approvals associated with this licence.</p></div>';else{const t=document.createElement("div");t.className="panel";for(const e of y){const c=document.createElement("a");c.className="panel-block is-block",c.dataset.licenceApprovalKey=e.licenceApprovalKey,c.innerHTML='<div class="columns is-mobile"><div class="column"><h4>'+cityssm.escapeHTML(e.licenceApproval)+'</h4><p class="is-size-7">'+cityssm.escapeHTML(e.licenceApprovalDescription)+"</p></div>"+(e.isRequiredForNew||e.isRequiredForRenewal?'<div class="column is-narrow"><i class="fas fa-asterisk" aria-hidden="true"</i></div>':"")+"</div>",c.addEventListener("click",m),y.length>1&&(c.draggable=!0,c.addEventListener("dragstart",v),c.addEventListener("dragover",f),c.addEventListener("drop",C)),t.append(c)}e.innerHTML="",e.append(t)}};let F;const E=t=>{let c;const n=t=>{t.preventDefault(),cityssm.postJSON(e+"/admin/doUpdateLicenceCategoryFee",t.currentTarget,e=>{e.success&&(r=!0,F=e.licenceCategoryFees,h(),c())})},i=()=>{cityssm.postJSON(e+"/admin/doDeleteLicenceCategoryFee",{licenceFeeId:t},e=>{e.success&&(F=e.licenceCategoryFees,h(),r=!0,c())})},a=e=>{e.preventDefault(),bulmaJS.confirm({title:"Delete Licence Fee",message:"Are you sure you want to delete this fee record?",contextualColorName:"warning",okButton:{text:"Yes, Delete It",callbackFunction:i}})},l=F.find(e=>e.licenceFeeId===t);cityssm.openHtmlModal("licenceCategoryFee-edit",{onshow:e=>{e.querySelector("#licenceCategoryFeeEdit--licenceFeeId").value=l.licenceFeeId.toString(),e.querySelector("#licenceCategoryFeeEdit--effectiveStartDateString").value=l.effectiveStartDateString,e.querySelector("#licenceCategoryFeeEdit--effectiveEndDateString").value=l.effectiveEndDateString,e.querySelector("#licenceCategoryFeeEdit--licenceFee").value=l.licenceFee.toFixed(2),l.renewalFee&&(e.querySelector("#licenceCategoryFeeEdit--renewalFee").value=l.renewalFee.toFixed(2)),l.replacementFee&&(e.querySelector("#licenceCategoryFeeEdit--replacementFee").value=l.replacementFee.toFixed(2))},onshown:(e,t)=>{c=t,e.querySelector("#form--licenceCategoryFeeEdit").addEventListener("submit",n),e.querySelector(".is-delete-button").addEventListener("click",a),bulmaJS.init(e)}})},L=e=>{e.preventDefault();const t=e.currentTarget.dataset.licenceFeeId;E(Number.parseInt(t,10))},h=()=>{const e=i.querySelector("#container--licenceCategoryFees");if(0===F.length)e.innerHTML='<div class="message is-warning"><p class="message-body">There are no fees associated with this licence.</p></div>';else{const t=document.createElement("div");t.className="panel";const c=cityssm.dateToString(new Date);for(const e of F){const n=document.createElement("a");n.className="panel-block is-block",n.dataset.licenceFeeId=e.licenceFeeId.toString();let i,a=!1;e.effectiveStartDate?(i="From "+e.effectiveStartDateString+(e.effectiveEndDate?" to "+e.effectiveEndDateString:""),e.effectiveStartDateString<=c&&(!e.effectiveEndDate||e.effectiveEndDateString>=c)&&(a=!0)):i='<span class="has-text-danger">No Effective Date</span>',n.innerHTML='<div class="columns is-mobile"><div class="column"><h4>'+i+'</h4><p class="is-size-7">$'+e.licenceFee.toFixed(2)+" fee</p></div>"+(a?'<div class="column is-narrow"><i class="fas fa-asterisk" aria-hidden="true"</i></div>':"")+"</div>",n.addEventListener("click",L),t.append(n)}e.innerHTML="",e.append(t)}},b=o=>{let s;const d=()=>{cityssm.postJSON(e+"/admin/doDeleteLicenceCategory",{licenceCategoryKey:o},e=>{e.success&&(r=!1,t=e.licenceCategories,s(),n())})},p=e=>{e.preventDefault(),bulmaJS.confirm({title:"Delete Licence Category",message:"Are you sure you want to delete this category?",contextualColorName:"warning",okButton:{text:"Yes, Delete It",callbackFunction:d}})},m=t=>{t.preventDefault();const c=t.currentTarget;cityssm.postJSON(e+"/admin/doUpdateLicenceCategory",c,e=>{e.success?(bulmaJS.alert({message:"Licence Category updated successfully.",contextualColorName:"success"}),r=!0):bulmaJS.alert({title:"Error Updating Licence Category",message:e.errorMessage,contextualColorName:"danger"})})},v=t=>{t.preventDefault();const c=t.currentTarget;cityssm.postJSON(e+"/admin/doAddLicenceCategoryField",c,e=>{e.success&&(r=!0,c.reset(),a=e.licenceCategoryFields,u(),l(e.licenceFieldKey))})},f=t=>{t.preventDefault();const c=t.currentTarget;cityssm.postJSON(e+"/admin/doAddLicenceCategoryApproval",c,e=>{e.success&&(r=!0,c.reset(),y=e.licenceCategoryApprovals,S(),g(e.licenceApprovalKey))})},C=t=>{t.preventDefault(),cityssm.postJSON(e+"/admin/doAddLicenceCategoryFee",{licenceCategoryKey:o},e=>{e.success&&(r=!0,F=e.licenceCategoryFees,h(),E(e.licenceFeeId))})},L=e=>{if(!e.success)return bulmaJS.alert({message:"Error loading Licence Category.",contextualColorName:"danger"}),void(r=!0);const t=e.licenceCategory;i.querySelector("#licenceCategoryEdit--licenceCategory").value=t.licenceCategory,i.querySelector("#licenceCategoryEdit--bylawNumber").value=t.bylawNumber;const c=i.querySelector("#licenceCategoryEdit--printEJS");if(!c.querySelector("option[value='"+t.printEJS+"']")){const e=document.createElement("option");e.value=t.printEJS,e.textContent=t.printEJS+" (Missing)",c.append(e)}c.value=t.printEJS;const n=i.querySelector("#licenceCategoryEdit--licenceLengthFunction");if(!n.querySelector("option[value='"+t.licenceLengthFunction+"']")){const e=document.createElement("option");e.value=t.licenceLengthFunction,e.textContent=t.licenceLengthFunction+" (Missing)",c.append(e)}n.value=t.licenceLengthFunction,i.querySelector("#licenceCategoryEdit--licenceLengthYears").value=t.licenceLengthYears.toString(),i.querySelector("#licenceCategoryEdit--licenceLengthMonths").value=t.licenceLengthMonths.toString(),i.querySelector("#licenceCategoryEdit--licenceLengthDays").value=t.licenceLengthDays.toString(),a=t.licenceCategoryFields,u(),y=t.licenceCategoryApprovals,S(),F=t.licenceCategoryFees,h()};r=!1,cityssm.openHtmlModal("licenceCategory-edit",{onshow:t=>{i=t,t.querySelector("#licenceCategoryEdit--licenceCategoryKey").value=o,t.querySelector("#licenceCategoryFieldAdd--licenceCategoryKey").value=o,t.querySelector("#licenceCategoryApprovalAdd--licenceCategoryKey").value=o;const c=t.querySelector("#licenceCategoryEdit--printEJS");for(const e of exports.printEJSList){const t=document.createElement("option");t.value=e,t.textContent=e,c.append(t)}const n=t.querySelector("#licenceCategoryEdit--licenceLengthFunction");for(const e of exports.licenceLengthFunctionNames){const t=document.createElement("option");t.value=e,t.textContent=e,n.append(t)}cityssm.postJSON(e+"/admin/doGetLicenceCategory",{licenceCategoryKey:o},L)},onshown:(e,t)=>{s=t,e.querySelector("#form--licenceCategoryEdit").addEventListener("submit",m),e.querySelector("#form--licenceCategoryFieldAdd").addEventListener("submit",v),e.querySelector("#form--licenceCategoryApprovalAdd").addEventListener("submit",f),e.querySelector(".is-add-fee-button").addEventListener("click",C),e.querySelector(".is-delete-button").addEventListener("click",p),bulmaJS.toggleHtmlClipped(),bulmaJS.init()},onhidden:()=>{r&&(c.innerHTML='<p class="has-text-centered has-text-grey-lighter"><i class="fas fa-3x fa-circle-notch fa-spin" aria-hidden="true"></i><br /><em>Loading licence categories...</em></p>',cityssm.postJSON(e+"/admin/doGetLicenceCategories",{},e=>{t=e.licenceCategories,n()}))},onremoved:()=>{bulmaJS.toggleHtmlClipped()}})},q=e=>{e.preventDefault();const t=e.currentTarget.dataset.licenceCategoryKey;b(t)};n(),document.querySelector("#button--addLicenceCategory").addEventListener("click",()=>{let c;const i=i=>{i.preventDefault(),cityssm.postJSON(e+"/admin/doAddLicenceCategory",i.currentTarget,e=>{e.success&&(t=e.licenceCategories,n(),c(),b(e.licenceCategoryKey))})};cityssm.openHtmlModal("licenceCategory-add",{onshown:(e,t)=>{bulmaJS.toggleHtmlClipped(),c=t,e.querySelector("form").addEventListener("submit",i)},onremoved:()=>{bulmaJS.toggleHtmlClipped()}})})})();