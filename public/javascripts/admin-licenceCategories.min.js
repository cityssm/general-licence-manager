"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),(()=>{const e=exports.glm,t=document.querySelector("main").dataset.urlPrefix,c=exports.includeReplacementFee;let i=exports.licenceCategories;const n=document.querySelector("#container--licenceCategories"),a=()=>{if(0===i.length)return void(n.innerHTML='<div class="message is-warning"><p class="message-body">There are no categories available.</p></div>');const e=document.createElement("div");e.className="panel";for(const t of i){const c=document.createElement("a");c.className="panel-block is-block",c.dataset.licenceCategoryKey=t.licenceCategoryKey,c.setAttribute("role","button"),c.innerHTML='<div class="columns is-multiline is-mobile"><div class="column is-6-tablet is-12-mobile"><strong>'+cityssm.escapeHTML(t.licenceCategory)+'</strong><br /><span class="is-size-7">'+cityssm.escapeHTML(t.bylawNumber)+'</span></div><div class="column is-6-mobile has-text-centered">'+(t.hasEffectiveFee?'<i class="fas fa-check has-text-success"></i><br /><span class="is-size-7">Effective Fee</span>':'<i class="fas fa-exclamation-triangle has-text-danger"></i><br /><span class="is-size-7">No Effective Fee</span>')+'</div><div class="column is-6-mobile has-text-centered">'+(""===t.printEJS?'<i class="fas fa-exclamation-triangle has-text-danger"></i><br /><span class="is-size-7">No Print Template</span>':'<i class="fas fa-check has-text-success"></i><br /><span class="is-size-7">Print Template</span>')+"</div></div>",c.addEventListener("click",x),e.append(c)}n.innerHTML="",n.append(e)};let r,l,o=!1;const s=e=>{let c;const i=e=>{e.preventDefault(),cityssm.postJSON(t+"/admin/doUpdateLicenceCategoryField",e.currentTarget,e=>{e.success&&(l=e.licenceCategoryFields,c(),m(),o=!0)})},n=()=>{cityssm.postJSON(t+"/admin/doDeleteLicenceCategoryField",{licenceFieldKey:e},e=>{e.success&&(l=e.licenceCategoryFields,m(),c(),o=!0)})},a=e=>{e.preventDefault(),bulmaJS.confirm({title:"Delete Field",message:"Are you sure you want to delete this field?",contextualColorName:"warning",okButton:{text:"Yes, Delete It",callbackFunction:n}})},r=l.find(t=>t.licenceFieldKey===e);cityssm.openHtmlModal("licenceCategoryField-edit",{onshow:t=>{t.querySelector("#licenceCategoryFieldEdit--licenceFieldKey").value=e,t.querySelector("#licenceCategoryFieldEdit--licenceField").value=r.licenceField,t.querySelector("#licenceCategoryFieldEdit--licenceFieldDescription").value=r.licenceFieldDescription,r.isRequired&&(t.querySelector("#licenceCategoryFieldEdit--isRequired").checked=!0);const c=t.querySelector("#licenceCategoryFieldEdit--minimumLength"),i=t.querySelector("#licenceCategoryFieldEdit--maximumLength");c.value=r.minimumLength.toString(),c.addEventListener("keyup",()=>{i.min=c.value}),i.value=r.maximumLength.toString(),i.min=r.minimumLength.toString(),t.querySelector("#licenceCategoryFieldEdit--pattern").value=r.pattern,t.querySelector("#licenceCategoryFieldEdit--printKey").value=r.printKey},onshown:(e,t)=>{c=t,e.querySelector("#licenceCategoryFieldEdit--licenceField").focus(),e.querySelector("#form--licenceCategoryFieldEdit").addEventListener("submit",i),e.querySelector(".is-delete-button").addEventListener("click",a),bulmaJS.init(e)},onhidden:()=>{document.querySelector("#form--licenceCategoryFieldAdd button[type='submit']").focus()}})},d=e=>{e.preventDefault();const t=e.currentTarget.dataset.licenceFieldKey;s(t)},u=e=>{e.dataTransfer.dropEffect="move";const t="licenceFieldKey:"+e.target.dataset.licenceFieldKey;e.dataTransfer.setData("text/plain",t)},p=e=>{if(e.dataTransfer.getData("text/plain").startsWith("licenceFieldKey:")){const t=e.dataTransfer.getData("text/plain").slice("licenceFieldKey:".length),c=e.currentTarget;t!==c.dataset.licenceFieldKey&&(e.preventDefault(),e.dataTransfer.dropEffect="move",c.style.borderTop="20px solid #ededed")}},y=e=>{e.currentTarget.style.borderTopWidth="0px"},g=e=>{e.preventDefault();const c=e.dataTransfer.getData("text/plain").slice("licenceFieldKey:".length),i=e.currentTarget.dataset.licenceFieldKey;cityssm.postJSON(t+"/admin/doMoveLicenceCategoryField",{licenceFieldKey_from:c,licenceFieldKey_to:i},e=>{l=e.licenceCategoryFields,m(),o=!0})},m=()=>{const e=r.querySelector("#container--licenceCategoryFields");if(0===l.length)e.innerHTML='<div class="message is-info"><p class="message-body">There are no additional fields captured with this category.</p></div>';else{const t=document.createElement("div");t.className="panel";for(const e of l){const c=document.createElement("a");c.className="panel-block is-block",c.dataset.licenceFieldKey=e.licenceFieldKey,c.style.transition="border-width 80ms",c.setAttribute("role","button"),c.innerHTML='<div class="columns is-mobile"><div class="column"><h4>'+cityssm.escapeHTML(e.licenceField)+'</h4><p class="is-size-7">'+cityssm.escapeHTML(e.licenceFieldDescription)+"</p></div>"+(e.isRequired?'<div class="column is-narrow"><i class="fas fa-asterisk" aria-hidden="true"</i></div>':"")+"</div>",c.addEventListener("click",d),l.length>1&&(c.draggable=!0,c.addEventListener("dragstart",u),c.addEventListener("dragover",p),c.addEventListener("dragleave",y),c.addEventListener("drop",g)),t.append(c)}e.innerHTML="",e.append(t)}};let v;const f=c=>{let i;const n=e=>{e.preventDefault(),cityssm.postJSON(t+"/admin/doUpdateLicenceCategoryApproval",e.currentTarget,e=>{e.success&&(v=e.licenceCategoryApprovals,i(),L(),o=!0)})},a=()=>{cityssm.postJSON(t+"/admin/doDeleteLicenceCategoryApproval",{licenceApprovalKey:c},e=>{e.success&&(v=e.licenceCategoryApprovals,L(),i(),o=!0)})},r=e=>{e.preventDefault(),bulmaJS.confirm({title:"Delete Approval",message:"Are you sure you want to delete this approval?",contextualColorName:"warning",okButton:{text:"Yes, Delete It",callbackFunction:a}})},l=v.find(e=>e.licenceApprovalKey===c);cityssm.openHtmlModal("licenceCategoryApproval-edit",{onshow:t=>{e.populateAliases(t),t.querySelector("#licenceCategoryApprovalEdit--licenceApprovalKey").value=c,t.querySelector("#licenceCategoryApprovalEdit--licenceApproval").value=l.licenceApproval,t.querySelector("#licenceCategoryApprovalEdit--licenceApprovalDescription").value=l.licenceApprovalDescription,l.isRequiredForNew&&(t.querySelector("#licenceCategoryApprovalEdit--isRequiredForNew").checked=!0),l.isRequiredForRenewal&&(t.querySelector("#licenceCategoryApprovalEdit--isRequiredForRenewal").checked=!0),t.querySelector("#licenceCategoryApprovalEdit--printKey").value=l.printKey},onshown:(e,t)=>{i=t,e.querySelector("#form--licenceCategoryApprovalEdit").addEventListener("submit",n),e.querySelector(".is-delete-button").addEventListener("click",r),bulmaJS.init(e)}})},C=e=>{e.preventDefault();const t=e.currentTarget.dataset.licenceApprovalKey;f(t)},S=e=>{e.dataTransfer.dropEffect="move";const t="licenceApprovalKey:"+e.target.dataset.licenceApprovalKey;e.dataTransfer.setData("text/plain",t)},F=e=>{if(e.dataTransfer.getData("text/plain").startsWith("licenceApprovalKey:")){const t=e.dataTransfer.getData("text/plain").slice("licenceApprovalKey:".length),c=e.currentTarget;t!==c.dataset.licenceApprovalKey&&(e.preventDefault(),e.dataTransfer.dropEffect="move",c.style.borderTop="20px solid #ededed")}},E=e=>{e.currentTarget.style.borderTopWidth="0px"},h=e=>{e.preventDefault();const c=e.dataTransfer.getData("text/plain").slice("licenceApprovalKey:".length),i=e.currentTarget.dataset.licenceApprovalKey;cityssm.postJSON(t+"/admin/doMoveLicenceCategoryApproval",{licenceApprovalKey_from:c,licenceApprovalKey_to:i},e=>{v=e.licenceCategoryApprovals,L(),o=!0})},L=()=>{const e=r.querySelector("#container--licenceCategoryApprovals");if(0===v.length)e.innerHTML='<div class="message is-info"><p class="message-body">There are no approvals associated with this category.</p></div>';else{const t=document.createElement("div");t.className="panel";for(const e of v){const c=document.createElement("a");c.className="panel-block is-block",c.dataset.licenceApprovalKey=e.licenceApprovalKey,c.setAttribute("role","button"),c.innerHTML='<div class="columns is-mobile"><div class="column"><h4>'+cityssm.escapeHTML(e.licenceApproval)+'</h4><p class="is-size-7">'+cityssm.escapeHTML(e.licenceApprovalDescription)+"</p></div>"+(e.isRequiredForNew||e.isRequiredForRenewal?'<div class="column is-narrow"><i class="fas fa-asterisk" aria-hidden="true"</i></div>':"")+"</div>",c.addEventListener("click",C),v.length>1&&(c.draggable=!0,c.addEventListener("dragstart",S),c.addEventListener("dragover",F),c.addEventListener("dragleave",E),c.addEventListener("drop",h)),t.append(c)}e.innerHTML="",e.append(t)}};let b;const q=i=>{let n;const a=e=>{e.preventDefault(),cityssm.postJSON(t+"/admin/doUpdateLicenceCategoryFee",e.currentTarget,e=>{e.success&&(o=!0,b=e.licenceCategoryFees,D(),n())})},r=()=>{cityssm.postJSON(t+"/admin/doDeleteLicenceCategoryFee",{licenceFeeId:i},e=>{e.success&&(b=e.licenceCategoryFees,D(),o=!0,n())})},l=e=>{e.preventDefault(),bulmaJS.confirm({title:"Delete Fee",message:"Are you sure you want to delete this fee record?",contextualColorName:"warning",okButton:{text:"Yes, Delete It",callbackFunction:r}})},s=b.find(e=>e.licenceFeeId===i);cityssm.openHtmlModal("licenceCategoryFee-edit",{onshow:t=>{e.populateAliases(t),t.querySelector("#licenceCategoryFeeEdit--licenceFeeId").value=s.licenceFeeId.toString(),t.querySelector("#licenceCategoryFeeEdit--effectiveStartDateString").value=s.effectiveStartDateString,t.querySelector("#licenceCategoryFeeEdit--effectiveEndDateString").value=s.effectiveEndDateString,t.querySelector("#licenceCategoryFeeEdit--licenceFee").value=s.licenceFee.toFixed(2),s.renewalFee&&(t.querySelector("#licenceCategoryFeeEdit--renewalFee").value=s.renewalFee.toFixed(2)),s.replacementFee&&(t.querySelector("#licenceCategoryFeeEdit--replacementFee").value=s.replacementFee.toFixed(2)),c||t.querySelector("#licenceCategoryFeeEdit--replacementFee").closest(".column").classList.add("is-hidden")},onshown:(e,t)=>{n=t,e.querySelector("#licenceCategoryFeeEdit--effectiveStartDateString").focus(),e.querySelector("#form--licenceCategoryFeeEdit").addEventListener("submit",a),e.querySelector(".is-delete-button").addEventListener("click",l),bulmaJS.init(e)}})},A=e=>{e.preventDefault();const t=e.currentTarget.dataset.licenceFeeId;q(Number.parseInt(t,10))},D=()=>{const e=r.querySelector("#container--licenceCategoryFees");if(0===b.length)e.innerHTML='<div class="message is-warning"><p class="message-body">There are no fees associated with this category.</p></div>';else{const t=document.createElement("div");t.className="panel";const c=cityssm.dateToString(new Date);for(const e of b){const i=document.createElement("a");i.className="panel-block is-block",i.dataset.licenceFeeId=e.licenceFeeId.toString();let n,a=!1;e.effectiveStartDate?(n="From "+e.effectiveStartDateString+(e.effectiveEndDate?" to "+e.effectiveEndDateString:""),e.effectiveStartDateString<=c&&(!e.effectiveEndDate||e.effectiveEndDateString>=c)&&(a=!0)):n='<span class="has-text-danger">No Effective Date</span>',i.innerHTML='<div class="columns is-mobile"><div class="column"><h4>'+n+'</h4><p class="is-size-7">$'+e.licenceFee.toFixed(2)+" fee</p></div>"+(a?'<div class="column is-narrow"><i class="fas fa-asterisk" aria-hidden="true"</i></div>':"")+"</div>",i.addEventListener("click",A),t.append(i)}e.innerHTML="",e.append(t)}},T=c=>{let d;const u=()=>{cityssm.postJSON(t+"/admin/doDeleteLicenceCategory",{licenceCategoryKey:c},e=>{e.success&&(o=!1,i=e.licenceCategories,d(),a())})},p=e=>{e.preventDefault(),bulmaJS.confirm({title:"Delete Category",message:"Are you sure you want to delete this category?",contextualColorName:"warning",okButton:{text:"Yes, Delete It",callbackFunction:u}})},y=e=>{e.preventDefault();const c=e.currentTarget;cityssm.postJSON(t+"/admin/doUpdateLicenceCategory",c,e=>{e.success?(bulmaJS.alert({message:"Category updated successfully.",contextualColorName:"success"}),o=!0):bulmaJS.alert({title:"Error Updating Category",message:e.errorMessage,contextualColorName:"danger"})})},g=e=>{e.preventDefault();const c=e.currentTarget;cityssm.postJSON(t+"/admin/doAddLicenceCategoryField",c,e=>{e.success&&(o=!0,c.reset(),l=e.licenceCategoryFields,m(),s(e.licenceFieldKey))})},C=e=>{e.preventDefault();const c=e.currentTarget;cityssm.postJSON(t+"/admin/doAddLicenceCategoryApproval",c,e=>{e.success&&(o=!0,c.reset(),v=e.licenceCategoryApprovals,L(),f(e.licenceApprovalKey))})},S=e=>{e.preventDefault(),cityssm.postJSON(t+"/admin/doAddLicenceCategoryFee",{licenceCategoryKey:c},e=>{e.success&&(o=!0,b=e.licenceCategoryFees,D(),q(e.licenceFeeId))})},F=e=>{if(!e.success)return bulmaJS.alert({message:"Error Loading Category.",contextualColorName:"danger"}),void(o=!0);const t=e.licenceCategory;r.querySelector("#licenceCategoryEdit--licenceCategory").value=t.licenceCategory,r.querySelector("#licenceCategoryEdit--bylawNumber").value=t.bylawNumber;const c=r.querySelector("#licenceCategoryEdit--printEJS");if(!c.querySelector("option[value='"+t.printEJS+"']")){const e=document.createElement("option");e.value=t.printEJS,e.textContent=t.printEJS+" (Missing)",c.append(e)}c.value=t.printEJS;const i=r.querySelector("#licenceCategoryEdit--licenceLengthFunction");if(!i.querySelector("option[value='"+t.licenceLengthFunction+"']")){const e=document.createElement("option");e.value=t.licenceLengthFunction,e.textContent=t.licenceLengthFunction+" (Missing)",c.append(e)}i.value=t.licenceLengthFunction,r.querySelector("#licenceCategoryEdit--licenceLengthYears").value=t.licenceLengthYears.toString(),r.querySelector("#licenceCategoryEdit--licenceLengthMonths").value=t.licenceLengthMonths.toString(),r.querySelector("#licenceCategoryEdit--licenceLengthDays").value=t.licenceLengthDays.toString(),l=t.licenceCategoryFields,m(),v=t.licenceCategoryApprovals,L(),b=t.licenceCategoryFees,D()};o=!1,cityssm.openHtmlModal("licenceCategory-edit",{onshow:i=>{r=i,e.populateAliases(i),i.querySelector("#licenceCategoryEdit--licenceCategoryKey").value=c,i.querySelector("#licenceCategoryFieldAdd--licenceCategoryKey").value=c,i.querySelector("#licenceCategoryApprovalAdd--licenceCategoryKey").value=c;const n=i.querySelector("#licenceCategoryEdit--printEJS");for(const e of exports.printEJSList){const t=document.createElement("option");t.value=e,t.textContent=e,n.append(t)}const a=i.querySelector("#licenceCategoryEdit--licenceLengthFunction");for(const e of exports.licenceLengthFunctionNames){const t=document.createElement("option");t.value=e,t.textContent=e,a.append(t)}cityssm.postJSON(t+"/admin/doGetLicenceCategory",{licenceCategoryKey:c},F)},onshown:(e,t)=>{d=t,e.querySelector("#licenceCategoryEdit--licenceCategory").focus(),e.querySelector("#form--licenceCategoryEdit").addEventListener("submit",y),e.querySelector("#form--licenceCategoryFieldAdd").addEventListener("submit",g),e.querySelector("#form--licenceCategoryApprovalAdd").addEventListener("submit",C),e.querySelector(".is-add-fee-button").addEventListener("click",S),e.querySelector(".is-delete-button").addEventListener("click",p),bulmaJS.toggleHtmlClipped(),bulmaJS.init()},onhidden:()=>{o&&(n.innerHTML='<p class="has-text-centered has-text-grey-lighter"><i class="fas fa-3x fa-circle-notch fa-spin" aria-hidden="true"></i><br /><em>Loading categories...</em></p>',cityssm.postJSON(t+"/admin/doGetLicenceCategories",{},e=>{i=e.licenceCategories,a()}))},onremoved:()=>{bulmaJS.toggleHtmlClipped()}})},x=e=>{e.preventDefault();const t=e.currentTarget.dataset.licenceCategoryKey;T(t)};a(),document.querySelector("#button--addLicenceCategory").addEventListener("click",()=>{let c;const n=e=>{e.preventDefault(),cityssm.postJSON(t+"/admin/doAddLicenceCategory",e.currentTarget,e=>{e.success&&(i=e.licenceCategories,a(),c(),T(e.licenceCategoryKey))})};cityssm.openHtmlModal("licenceCategory-add",{onshow:t=>{e.populateAliases(t)},onshown:(e,t)=>{bulmaJS.toggleHtmlClipped(),c=t,e.querySelector("form").addEventListener("submit",n),e.querySelector("#licenceCategoryAdd--licenceCategory").focus()},onhidden:()=>{document.querySelector("#button--addLicenceCategory").focus()},onremoved:()=>{bulmaJS.toggleHtmlClipped()}})})})();