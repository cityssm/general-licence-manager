"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),(()=>{const e=document.querySelector("main").dataset.urlPrefix,t=document.querySelector("#licenceEdit--licenceId").value,n=""===t;let c=!1;const o=()=>{c=!0,cityssm.enableNavBlocker()},i=document.querySelector("#form--licenceEdit");i.addEventListener("submit",t=>{t.preventDefault();const o=e+"/licences/"+(n?"doCreateLicence":"doUpdateLicence");cityssm.postJSON(o,t.currentTarget,t=>{t.success?(c=!1,cityssm.disableNavBlocker(),n?window.location.href=e+"/licences/"+t.licenceId.toString()+"/edit":bulmaJS.alert({message:"Licence Updated Successfully",contextualColorName:"success"})):bulmaJS.alert({title:"Error Updating Licence",message:t.errorMessage,contextualColorName:"danger"})})});const a=i.querySelectorAll("input, select");for(const e of a)e.hasAttribute("name")&&e.addEventListener("change",o);const l=e=>{e.preventDefault();const t=e.currentTarget.closest(".field").querySelector("input");t.readOnly=!1,t.focus()},s=i.querySelectorAll(".is-unlock-button");for(const e of s)e.addEventListener("click",l);const r=document.querySelector("#licenceEdit--licenceCategoryKey"),d=document.querySelector("#licenceEdit--isRenewal"),u=document.querySelector("#licenceEdit--startDateString"),p=document.querySelector("#licenceEdit--endDateString"),m=()=>{const e=u.valueAsDate;if(p.readOnly=!0,!e||""===r.value)return void(p.value="");const t=r.selectedOptions[0],n=Number.parseInt(t.dataset.licenceLengthYears),c=Number.parseInt(t.dataset.licenceLengthMonths),o=Number.parseInt(t.dataset.licenceLengthDays);n>0&&(e.setFullYear(e.getFullYear()+n),e.setDate(e.getDate()-1)),c>0&&(e.setMonth(e.getMonth()+c),e.setDate(e.getDate()-1)),o>0&&e.setDate(e.getDate()+o-1),p.valueAsDate=e};let y;n&&r.addEventListener("change",m),u.addEventListener("change",m);const v=()=>{const e=document.querySelector("#licenceEdit--licenceFee"),t=document.querySelector("#licenceEdit--replacementFee");if(!y||0===y.licenceCategoryFees.length)return e.value="",void(t.value="");e.value=d.checked?y.licenceCategoryFees[0].renewalFee.toFixed(2):y.licenceCategoryFees[0].licenceFee.toFixed(2),t.value=y.licenceCategoryFees[0].replacementFee.toFixed(2)},g=()=>{(()=>{const e=document.querySelector("#container--licenceFields");if(!y||0===y.licenceCategoryFields.length)return e.innerHTML="",void e.classList.add("is-hidden");e.classList.remove("is-hidden"),e.innerHTML='<h2 class="panel-heading">Fields</h2>';const t=[];for(const n of y.licenceCategoryFields){const c=document.createElement("div");c.className="panel-block is-block",c.innerHTML='<div class="field"><label class="label"></label><div class="control"><input class="input" type="text" /></div></div>';const o="licenceFieldEdit--"+n.licenceFieldKey,i=c.querySelector("label");i.setAttribute("for",o),i.textContent=n.licenceField;const a=c.querySelector("input");if(a.id=o,a.name="field--"+n.licenceFieldKey,a.minLength=n.minimumLength,a.maxLength=n.maximumLength,""!==n.pattern&&(a.pattern=n.pattern),n.isRequired&&(a.required=!0),""!==n.licenceFieldDescription){const e=document.createElement("p");e.className="help",e.textContent=n.licenceFieldDescription,c.append(e)}e.append(c),t.push(n.licenceFieldKey)}const n=document.createElement("input");n.type="hidden",n.name="licenceFieldKeys",n.value=t.join(","),e.append(n)})(),(()=>{const e=document.querySelector("#container--licenceApprovals");if(!y||0===y.licenceCategoryApprovals.length)return e.innerHTML="",void e.classList.add("is-hidden");e.classList.remove("is-hidden"),e.innerHTML='<h2 class="panel-heading">Approvals</h2>';const t=[];for(const n of y.licenceCategoryApprovals){const c=document.createElement("div");c.className="panel-block is-block",c.innerHTML='<div class="facheck"><input type="checkbox" /><label></label></div>';const o="licenceApprovalEdit--"+n.licenceApprovalKey,i=c.querySelector("label");i.setAttribute("for",o),i.textContent=n.licenceApproval;const a=c.querySelector("input");if(a.id=o,a.name="approval--"+n.licenceApprovalKey,a.dataset.isRequiredForNew=n.isRequiredForNew?"true":"false",a.dataset.isRequiredForRenewal=n.isRequiredForRenewal?"true":"false",(d.checked&&n.isRequiredForRenewal||!d.checked&&n.isRequiredForNew)&&(a.required=!0),""!==n.licenceApprovalDescription){const e=document.createElement("p");e.className="help",e.textContent=n.licenceApprovalDescription,c.append(e)}e.append(c),t.push(n.licenceApprovalKey)}const n=document.createElement("input");n.type="hidden",n.name="licenceApprovalKeys",n.value=t.join(","),e.append(n)})(),v()},h=()=>{if(""===r.value)return y=void 0,void g();cityssm.postJSON(e+"/licences/doGetLicenceCategory",{licenceCategoryKey:r.value},e=>{y=e.licenceCategory,g()})};n?(r.addEventListener("change",h),""!==r.value&&h()):y=exports.licenceCategory,d.addEventListener("change",()=>{const e=document.querySelector("#container--licenceApprovals").querySelectorAll("input");for(const t of e)t.required=!!(d.checked&&"true"===t.dataset.isRequiredForRenewal||!d.checked&&"true"===t.dataset.isRequiredForNew);v()});const S=document.querySelector("#table--licenceTransactions");let f;const q=()=>{const e=document.querySelector("#licenceEdit--licenceFee").value,t=S.querySelectorAll("tfoot th")[1].textContent.slice(1);return Math.max(Number.parseFloat(e)-Number.parseFloat(t),0)},F=n=>{let c,o;n.preventDefault();const i=t=>{t.preventDefault(),cityssm.postJSON(e+"/licences/doAddLicenceTransaction",t.currentTarget,e=>{e.success&&(f=e.licenceTransactions,(()=>{const e=S.querySelector("tbody");e.innerHTML="";let t=0;for(const n of f){const c=document.createElement("tr");c.dataset.transactionIndex=n.transactionIndex.toString(),c.innerHTML="<td>"+n.transactionDateString+'</td><td class="has-text-right">$'+n.transactionAmount.toFixed(2)+"</td>",e.append(c),t+=n.transactionAmount}S.querySelectorAll("tfoot th")[1].textContent="$"+t.toFixed(2)})(),o())})},a=e=>{e.preventDefault();const t=e.currentTarget.dataset.spanId;c.querySelector("#transactionAdd--transactionAmount").value=c.querySelector("#"+t).textContent};cityssm.openHtmlModal("transaction-add",{onshow:e=>{e.querySelector("#transactionAdd--licenceId").value=t;const n=document.querySelector("#licenceEdit--licenceFee").value;e.querySelector("#transactionAdd--licenceFee").textContent=n,e.querySelector("#transactionAdd--replacementFee").textContent=document.querySelector("#licenceEdit--replacementFee").value;const c=q();e.querySelector("#transactionAdd--outstandingBalance").textContent=c.toFixed(2)},onshown:(e,t)=>{c=e,o=t;const n=e.querySelectorAll(".is-set-transaction-amount-button");for(const e of n)e.addEventListener("click",a);e.querySelector("#form--transactionAdd").addEventListener("submit",i)}})};n||document.querySelector("#button--addTransaction").addEventListener("click",F);const L=document.querySelector("#is-issue-licence-button");if(L){const n=()=>{cityssm.postJSON(e+"/licences/doIssueLicence",{licenceId:t},e=>{e.success&&window.location.reload()})};L.addEventListener("click",e=>{e.preventDefault(),c?bulmaJS.alert({title:"Licence Has Unsaved Changes",message:"Please save your licence changes before issuing the licence.",contextualColorName:"warning"}):q()>0?bulmaJS.confirm({title:"Licence Has an Outstanding Balance",message:"Are you sure you want to issue this licence with an outstanding balance?",contextualColorName:"warning",okButton:{text:"Yes, Issue with Outstanding Balance",callbackFunction:n}}):bulmaJS.confirm({title:"Issue Licence",message:"Are you sure you want to issue this licence?",contextualColorName:"info",okButton:{text:"Yes, Issue Licence",callbackFunction:n}})})}n||document.querySelector("#is-delete-licence-button").addEventListener("click",n=>{n.preventDefault();const c=!L,o=p.value<cityssm.dateToString(new Date);bulmaJS.confirm({title:"Delete Licence",message:"<p>Are you sure you want to delete this licence?</p>"+(c?"<p>Note that <strong>this licence has been issued</strong>, and deleting it may cause confusion.</p>":""),messageIsHtml:!0,contextualColorName:o?"info":"warning",okButton:{text:"Yes, Delete Licence",callbackFunction:()=>{cityssm.postJSON(e+"/licences/doDeleteLicence",{licenceId:t},t=>{t.success&&(window.location.href=e+"/licences")})}}})})})();